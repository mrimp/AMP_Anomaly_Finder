<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAICAAAAEAGACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALGBkOFhYPFxcLFxUNFhQOFRUMFxgLFRYPFhcMGRceKy5LX2RHYmlKY29NXGZGXmhLXmRIXGFKYmNOXWVGX2ItNTgGExQJExMNExMMEhYJEBMLExIKFBMKExEKEg4GExQKGRkRFxYNFxgOGBYMFxUQGBcLGRcMFxYyQERVZnJPX2YfLjEQGBgOFhcLFRoLFRsKFxcKFhYHFRQLFRYWISFNVltVZW1CT1QNFRUNFBcLExQLEhIIFBIJFBIKFRQJFRENGBcKGBkKGBsPFxYLGBcLGR0ZIilQaGxLW18PGx0NGhkLGRcMGRgNGBgMFxgIFxkIFhgIFxcJFxgJFRYMFhQNFxMMFhU/TFFZbHAnMzUMFxMJFRIJFxUKFBIIFhMJFhMQGhoOGRsPGRcOGRcLGRgvPUFZcHkhLzENGhYLGRYMGBcKGRgOGhkTGxkOGRYJFxcLFRoLGBcJFhYIFhUNFxcMFBYOFRUMExMOGh1dZ29HUFYLFRUKFhYJFBILFRIMFBQOGBcRGRgSGRcOGhk1RU1SbHUNHR8OGRgOFxgOHBwUHSEOHR0OHR0VHCASHR0MGhoPGBkNGxoJGRoJGRcMGBUQFxcMFRYKFRUKFhYKFBhKWl9JW14MGRgJFhQKFxIIFhMNGhoPGRwPGBovPT9YaHURGSENGxsMGhoPGhsXIyRtcXNMUVQZJiajqanCyMhrcXIRHR4NGhoOGhoOGRgMFxgPFxYLFxgLFhcKFxgKFRYKFxlKWl5HWFwMFxUMFxMKFxQPGRkQGBscJiZccHUQGiERHBwpMjFdYmEeJSmMk5PU2trK0NBlbGzT2tnY396rsbEUHh0QGxwNGRgOGRoMFxsNGBcNFhUPFhUKFhgMFhYMFhUJFhZTZ20vQEIKFxULGBYOGhoRGBtZa3MkMzULGhkTHyCvubnP1NOkqKqUm53S19fJ0c1MVFWus7bEycprc3MPISAIHBwKGhsNGxoNGxsLGhoKGBcMFxYLFxkMGBoJGBYIGBUNGRhccHYPGBsJGBgLGxowPUNSYmkNGx0MHCEVHyW9xsjO1NS3vb0wOj+FiY55g4QUJi9JU2FMYG9HXGdRZG9PZHBTY3IpMjsRGhsOHBoJGhcKFhgOFRgOFhYLGhgJGRYKFxY3REhQX2YMFhsPHBpdbncUHyQOGxwQHR8aIiNkam2Ol5eSm5/DztOPk5k2SFBQY3A2RE8PIioNHiUQHCQNHSIdKzRWYnBXaXUTICYOGxoPGRsPFxgLGBcJGhcIGRgKGRcLGhldcHcOGR8YKSlaa3AVGx4ZIiOor6++xsRZZGYXKSiirK/P2dvM09SgsbaywMWAhopVXmIRISUOHSMNHyEPHSIPHCAsNz1mdH8bKCkNGhgOGBgKGBcKGRgKGRkNGhkIGRdAUlVDVVhPYGYuPEASGxw1PT/N1NPQ2Naao6IaKSe4vb7Y3+DT29y+yM3G0dbM1tjF0tRGUFQPICYOIyUOICESHyAQHR8iLjNgc3sLGhoOGRsOGRkLGhkLGRcLGBcMGRkOHBpacXRbanESGx4THR4OISSboaDGzMtkbGshLS3Dx8vb4ubS2929w8esur7AyM/FztJIUFcWJSuKkpWjq60vODkUISIRHyBBTldGV18QGhkRGhkPHBsOGxkNGxkNGx0KGx5ccnVZa3MPHBsOHRsMHB0THx4sNDMVIyRrc3TR2dzU3N/g5ObX3d92gYRlanBVXGASIihia27V3uHW4OOXoKQUIiURHx0OGx5Ub3sKGhsMGhgPHhoNHhsLHxsNHRoOHBxVb3ZcbXQVHhwOHBtLYGUSIiZWa3dAUVpGS0zL1djd5eji5+rc4ubDzdFNWF0xQEpHXmpQYGnL2uHG09VgaW8WJCoPISEMHyFVb3gVIycOHBwRIiQOIR8QIyUTISQNGxxPa3RUc3kbLCwfLS5xjpxYaXNjdYR2kZ4YLC+ptb3c5efe6OvK1NqruL46RUwQISpoi59xla1EUl57gou7xc2SoKYQIiQOIiFPXWc3QUkLGh5pg5AmOkN0kZ56k5wPISJNZGxUbXYQIiFEW2B2k6RgdINNZG90k58WLDJjeYWmrq7K1NixvcI/S1QlNDoiMzqQoq26y9ZbZm+psrnU3uPN2N0qOEAhNDpNYGo/UlwgMjhrkqBDYWhih5J2lKElNzxVa3JVbXQMHBszRkp3kp0zQUl0j51jgo0QHiRabXgbJShWXmUuOUEUJCoXJCY8R0zU3+XZ4ueqsrlibXC0vMGHkZcYJy0SICZUa3cdLjc7TFaIrr4uQ0trlKB1k6ARISZdbXVbcHYMHhwMHh0PHyEPGx4QHyENHyITHyBcanYrNz8WIyoSJCoRJSkRHyQYICirsLnF0dN/iY4VIioZJDAYKjEUJSsRHydYbnkPHiARHSMzREoQISNAUlkzQkkNIB9dcHdgbncMHyIPHRsQHhwRHB0THyANHiAPHyEqND9fa3kSIihKVFSAiYo+R0oTHyURICcXJikPIicQIycRISgTJy0TJCQlMDlRZXAOHyEPHx4THx8RHyIQHh8OHRwPICBXcXZVZ2wtPkEQHBwUHhwRHRsSHx0QHxwRHx4RHh9XbncwQkq9zMzQ3uC0v8MVIigRIiUQISIRHyIRICARHyITJSQPJCRWbngYLDAPIiITHx8VICQQISMRIiAMHx8bKy9aanIfLC5cbHINHBsOHxwOHxsUHR0SHB8QIB8RHyARIydhdYS2w8fR3d2ksbEXIykVICMPICIMHx4PHx4SHh8OIiRKZ3Q6TVMOIyQPISQUHiESISUOICARIiASISFUZmwnOz4PHx1hcngTIyIQHRsLHxsQHx0QGyINHiEPHiIQICIYKCpgdYBsf4YiNjkSIiUTIyAOIh8NICILICMsOkFjdH0+T1MTISINICIQIiISIiAQHx8OHx0OIB0QISNgc3oRIR4PIBw0REZUaWsNHRoOHBoQHh4MHiINHiERHyARHyATHh4QHiI9UFdQaXVHaHJTaW9UZm1dcHlXcXhTZ3AXKCoSISARJSUTIB8WISIUISMOHx4LIR4PIR5PXmQ7SlETIiAMHhwPHRxgdHclNjcQHBsQHx4NHyESICMTHyMSIB8THR8RHyQSICQSICMVIiQiNToqOT8XKSwOIiQUIiQRIiUPHyEQISMUIyITIB8RHyIOHx4MIB8kMjReb3IRIh4VIR0PIRoSHhwZKClie4ISHyEOHiMPHSESICIRIiITIiARISAQHyEQICIVHh8UHx4PHyAOHx0RIB4RICIUIyMVJCIQHyQQIiMWISAWICEWHiEQIR8RIyNfdnodLS0UIiIUISMRIhgSHxoPHRs0QkZjdHoRISUOHyEQIR4RISASHx8RHiAPHyISHx8VHCATHh8OHCAOHR0SIB8RIiQWIiQaIyARISANIB8OIB8TICEVICMUIyFZc3gwRUgTJiMUJR8VIx4TIBgTHhsTHRsOHxw+TE9jcngQISgPIB4MIh4PIR8RICISHx4PISESHCAQHR0LHiAQHB8THiAPIiESIyETICERISESIB8SHx4RHx8TIylkdHs4TE8PIx8SIBwXIR0VIh8THhoTHR0WHx0TIB8RHx0zP0RleYIwPkARIB8THx8UHyITHyEQHx4SHh8OHx4RHx8THR4PIB4PIh8PISESIyUSJCQVIiMTHyArPkJheoMxQEUOIB4PIh8RIR4VHx4SHiAQIBkSHx0UIB0YHx4UHx0RIyEXJSVdcHJebm8ZLC4TIiARHiASHh8THh8QHyEOHyEPHyEQIB0QJCAQIyMQIiAPIiMZKS9WbXRXb3YWJCYQIxwOIhwNIh0NIR0MHiAOIyQQJB4RHB4SHx0WHh4RHh0VHx0RICAWIR8pNzhdcnhXbXI8UlIUIiQTICEUIR4RHx0QHhsSIR8PIR8SIyc6S0pTa25QaXAqOzwVHx4UIR0RIBoPIxwOJBgPJRoNISARIx8TIhwSIB4TIBwVHhsSHxwVHx0THiAVIB4QIB8QHyQTIihFV1hgcnJib3ZZcHVabnBXbm9bcHBacnNecHREWVwWIygQHx0TIB0RIB4PIh4TIR8QIh0TJRoUIxsQIxsUJCMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>AMP Anomaly Finder — Offline (Refactor)</title>
<style>
    *{box-sizing:border-box}
  body{
    margin:0; color:var(--txt); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:
      radial-gradient(1100px 600px at 20% -10%, rgba(56,189,248,.18), transparent 60%),
      radial-gradient(1000px 600px at 85% 0%, rgba(167,139,250,.14), transparent 55%),
      linear-gradient(180deg, var(--bg0), #050914);
    min-height:100vh;
  }
  header{
    padding:18px 18px 10px;
    display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
  }
  header h1{margin:0; font-size:18px; letter-spacing:.2px}
  header .sub{margin:2px 0 0; color:var(--mut); font-size:12px}
  header .right{display:flex; gap:10px; align-items:center}
  .pill{
    font-size:12px; color:var(--mut); border:1px solid var(--line); padding:6px 10px; border-radius:999px;
    background:rgba(15,34,52,.55);
  }
  main{display:grid; grid-template-columns: 340px 1fr; gap:14px; padding:0 14px 16px;}
  .card{
    border:1px solid rgba(31,53,80,.7);
    background: linear-gradient(180deg, rgba(15,34,52,.72), rgba(11,26,43,.62));
    box-shadow: 0 12px 30px rgba(0,0,0,.25);
    border-radius:16px;
    overflow:hidden;
  }
  .card h2{margin:0; padding:12px 14px; font-size:13px; letter-spacing:.2px; border-bottom:1px solid rgba(31,53,80,.6); color:#d8e6f8}
  .card .body{padding:12px 14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    background:#12314c; border:1px solid rgba(56,189,248,.35);
    color:var(--txt); padding:8px 10px; border-radius:12px; cursor:pointer; font-weight:600; font-size:12px;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn.secondary{background:transparent; border:1px solid rgba(31,53,80,.9); color:var(--mut)}
  input[type="file"]{display:none}
  .drop{
    border:1px dashed rgba(56,189,248,.45);
    border-radius:14px; padding:12px; background:rgba(3,11,22,.35);
    color:var(--mut); font-size:12px;
  }
  .drop strong{color:var(--txt)}
  .kv{display:grid; grid-template-columns: 1fr auto; gap:6px 10px; margin-top:10px; font-size:12px}
  .kv div:nth-child(odd){color:var(--mut)}
  .kv div:nth-child(even){font-variant-numeric: tabular-nums;}
  .control{margin-top:10px}
  label{font-size:12px; color:var(--mut)}
  input[type="range"]{width:100%}
  select, input[type="text"]{
    width:100%;
    background:rgba(3,11,22,.5);
    border:1px solid rgba(31,53,80,.85);
    color:var(--txt);
    padding:9px 10px; border-radius:12px; outline:none;
  }
  select:focus, input[type="text"]:focus{border-color:rgba(56,189,248,.65)}
  /* Ensure native dropdown menus render in a dark scheme (prevents white-on-white option lists) */
  select{color-scheme:dark;}
  select option, select optgroup{
    background:rgba(3,11,22,.95);
    color:var(--txt);
  }

  .hint{font-size:12px; color:var(--mut); line-height:1.35}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  .split{display:flex; gap:10px}
  .split > *{flex:1}
  .tog{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:12px; color:var(--mut)}
  .tog input{transform: translateY(1px)}
  .badges{display:flex; gap:6px; flex-wrap:wrap}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid rgba(31,53,80,.8);
    background:rgba(3,11,22,.35); color:var(--mut);
  }
  .dot{width:8px; height:8px; border-radius:999px; display:inline-block}
  .dot.good{background:var(--good)}
  .dot.mid{background:var(--mid)}
  .dot.hi{background:var(--hi)}
  .dot.warn{background:var(--warn)}
  .dot.bad{background:var(--bad)}
  /* Right side table */
  .tableWrap{overflow:auto; overflow-x:auto; max-height: calc(100vh - 120px);}
  .tableWrap table{min-width: 1400px;}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px}
  thead th{
    position:sticky; top:0; z-index:2;
    background:rgba(9,20,34,.95);
    border-bottom:1px solid rgba(31,53,80,.9);
    padding:10px 10px; text-align:left; color:#cfe1f5; font-weight:700;
    white-space:nowrap;
  }
  tbody td{
    border-bottom:1px solid rgba(31,53,80,.35);
    padding:8px 10px; vertical-align:middle;
  }
  tbody tr:hover{background:rgba(56,189,248,.06)}
  tbody tr.selected{outline:2px solid rgba(124,220,255,.55); outline-offset:-2px; background:rgba(124,220,255,.10)}
  tbody tr.normal{background:transparent}
  tbody tr.moderate{background:rgba(56,189,248,.06)}
  tbody tr.high{background:rgba(245,158,11,.08)}
  tbody tr.flyer{background:rgba(239,68,68,.10)}
  .sessionBar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px 14px; border-bottom:1px solid rgba(31,53,80,.6);
  }
  .sessionPill{
    display:flex; align-items:center; gap:8px;
    border:1px solid rgba(31,53,80,.85);
    background:rgba(3,11,22,.35);
    padding:8px 10px; border-radius:999px; max-width:100%;
    min-width:0;
  }
  .sessionPill .label{
    min-width:0; max-width:100%;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    font-size:12px; color:var(--txt); font-weight:700;
  }
  .sessionPill .meta{font-size:11px; color:var(--mut); white-space:nowrap}
  .chip{
    font-size:11px; color:var(--mut); border:1px solid rgba(31,53,80,.8);
    padding:4px 8px; border-radius:999px; background:rgba(3,11,22,.25);
  }
  .warnBox{
    margin:12px 14px; padding:12px; border-radius:14px;
    border:1px solid rgba(245,158,11,.35);
    background:rgba(245,158,11,.08); color:#f7d9a5;
  }
  .kbd{font-family:ui-monospace; font-size:11px; padding:1px 6px; border:1px solid rgba(31,53,80,.9); border-radius:6px; background:rgba(3,11,22,.35); color:var(--mut)}
  .small{font-size:11px; color:var(--mut)}
  .nowrap{white-space:nowrap}

/* v2.1 patches */
.control select{max-width:100%; width:100%;}
.sessionPill .label{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;}
tr.excluded{opacity:.55;}
.viewTabs{display:flex; gap:8px; align-items:center;}
.viewTabs .tabbtn{padding:7px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--txt); cursor:pointer; font-weight:600;}
.viewTabs .tabbtn.active{background:rgba(124,220,255,.18); border-color:rgba(124,220,255,.35);}
.sessionsWrap{display:none;}
.sessionsWrap table{width:100%; border-collapse:separate; border-spacing:0 10px;}
.sessionsWrap th{font-size:12px; color:var(--mut); text-align:left; padding:0 10px;}
.sessionsWrap td{padding:10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);}
.sessionsWrap tr:hover td{background:rgba(255,255,255,.06); cursor:pointer;}

  th.sortedAsc::after{content:' ▲'; opacity:.7;}
  th.sortedDesc::after{content:' ▼'; opacity:.7;}

.tableWrap{ overflow:auto; }
.tableWrap table{ min-width: 1200px; }
.tableWrap thead th:nth-child(1),
.tableWrap tbody td:nth-child(1){
  position: sticky; left: 0; 
  min-width:120px; width:120px;
}
.tableWrap thead th:nth-child(1){ z-index: 7; background: rgba(10,16,28,.98); }
.tableWrap tbody td:nth-child(1){ z-index: 4; background: rgba(8,12,18,.96); }

.tableWrap thead th:nth-child(2),
.tableWrap tbody td:nth-child(2){
  position: sticky; left: 120px;
  min-width:90px; width:90px;
}
.tableWrap thead th:nth-child(2){ z-index: 7; background: rgba(10,16,28,.98); }
.tableWrap tbody td:nth-child(2){ z-index: 4; background: rgba(8,12,18,.96); }

.tableWrap thead th:nth-child(3),
.tableWrap tbody td:nth-child(3){
  position: sticky; left: 210px;
  min-width:110px; width:110px;
}
.tableWrap thead th:nth-child(3){ z-index: 7; background: rgba(10,16,28,.98); }
.tableWrap tbody td:nth-child(3){ z-index: 4; background: rgba(8,12,18,.96); }

/* subtle divider after pinned columns */
.tableWrap thead th:nth-child(3),
.tableWrap tbody td:nth-child(3){
  box-shadow: 8px 0 18px rgba(0,0,0,.22);
}
.tableWrap tbody tr.excluded td:first-child{
  background: rgba(10,16,28,.92);
}

/* ===== Suite header + NodeLab-like theme (shared kit) ===== */
:root{
  --suite-bg0: rgb(17,22,27);
  --suite-bg1: rgb(25,33,40);
  --suite-panel0: rgb(34,42,55);
  --suite-panel1: rgb(25,33,40);

  --suite-text: rgb(223,230,236);
  --suite-muted: rgb(149,166,178);
  --suite-faint: rgb(101,109,112);

  --suite-border: rgba(255,255,255,.10);
  --suite-border2: rgba(255,255,255,.06);

  --suite-shadow: 0 18px 50px rgba(0,0,0,.45);
  --suite-shadow2: 0 10px 22px rgba(0,0,0,.35);

  --suite-r-lg: 28px;

  /* legacy theme vars (kept for backwards-compat with existing CSS) */
  --bg0: var(--suite-bg0);
  --bg1: var(--suite-bg1);
  --card: var(--suite-panel0);
  --card2: var(--suite-panel1);
  --txt: var(--suite-text);
  --mut: var(--suite-muted);
  --line: var(--suite-border);

  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --mid:#38bdf8; --hi:#a78bfa;
}

/* background + text */
body{
  background:
    radial-gradient(1200px 600px at 20% 0%, rgba(52,66,85,.55), transparent 60%),
    radial-gradient(900px 520px at 90% 10%, rgba(34,42,55,.55), transparent 55%),
    linear-gradient(180deg, var(--suite-bg1), var(--suite-bg0));
  color: var(--suite-text);
}

.suiteHeader__badge--img{ position:relative; overflow:hidden; padding:0; }
.suiteHeader__badge--img img{ width:100%; height:100%; object-fit:cover; display:block; filter: contrast(1.02) saturate(1.02); }
.suiteHeader__badgeText{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:.4px; color: rgba(154,169,180,.75); }

/* NodeLab-style header */
.suiteHeader{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  padding: 12px 16px;
  border-radius: var(--suite-r-lg);
  border: 1px solid var(--suite-border);
  box-shadow: var(--suite-shadow);
  background: linear-gradient(135deg, rgba(34,42,55,.65), rgba(25,33,40,.55));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  margin: 12px 12px 16px;
}

.suiteHeader__topline{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
.suiteHeader__title{ font-size: 30px; font-weight: 760; letter-spacing: .2px; }
.suiteHeader__pill{
  font-size: 14px; padding: 4px 10px; border-radius: 999px;
  border: 1px solid var(--suite-border2);
  background: rgba(0,0,0,.18);
  color: var(--suite-muted);
}
.suiteHeader__pill--muted{ opacity:.85; }
.suiteHeader__tagline{ margin-top: 6px; color: var(--suite-muted); font-size: 15px; line-height: 1.25; }

.suiteHeader__right{ display:flex; align-items:center; gap:12px; }
.suiteHeader__actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
.suiteHeader__badge{
  width: 52px; height: 52px; border-radius: 999px;
  border: 1px solid var(--suite-border);
  background: radial-gradient(circle at 30% 30%, rgba(223,230,236,.12), rgba(0,0,0,.2));
  box-shadow: var(--suite-shadow2);
  display:flex; align-items:center; justify-content:center;
  color: var(--suite-faint);
  font-weight: 800;
  letter-spacing: .6px;
}

/* keep your existing layout, but stop using the old <header> rules */
header h1, header .sub, header .right{ all: unset; }

/* responsive: stack header content on small screens */
@media (max-width: 820px){
  .suiteHeader{ flex-direction:column; align-items:stretch; }
  .suiteHeader__right{ justify-content:space-between; }
  .suiteHeader__title{ font-size: 28px; }
  .suiteHeader__tagline{ font-size: 16px; }
}

header{padding:0; display:block; gap:0; align-items:unset; justify-content:unset;}

/* ===== UI/UX upgrades (v3.3) ===== */
.wizard{
  display:flex; gap:10px; flex-wrap:wrap;
  padding:10px; border-radius:14px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
.wizStep{
  display:flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.10);
  font-size:12px;
  color: rgba(255,255,255,.78);
}
.wizDot{
  width:10px; height:10px; border-radius:999px;
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.18);
}
.wizStep.done{ color: rgba(255,255,255,.88); }
.wizStep.done .wizDot{ background: rgba(34,197,94,.75); border-color: rgba(34,197,94,.75); }
.wizStep.active{ color: rgba(255,255,255,.92); box-shadow: 0 0 0 2px rgba(56,189,248,.15) inset; }
.wizStep.active .wizDot{ background: rgba(56,189,248,.75); border-color: rgba(56,189,248,.75); }

.menu{
  position:absolute; right:0; top:44px; min-width: 190px;
  padding:8px; border-radius:14px;
  background: rgba(10,16,28,.98);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  z-index: 50;
}
.menuItem{
  width:100%; text-align:left;
  padding:10px 10px;
  border-radius:12px;
  background: transparent;
  border: 1px solid transparent;
  color: rgba(255,255,255,.86);
  cursor:pointer;
  font: 600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.menuItem:hover{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.10);
}
.menuItem.danger{ color: rgba(255,180,180,.95); }
.menuSep{
  height:1px; margin:8px 4px;
  background: rgba(255,255,255,.10);
}

.infoTip{
  display:inline-flex; align-items:center; justify-content:center;
  width:18px; height:18px; margin-left:6px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.78);
  font-size:12px;
  cursor: help;
  user-select:none;
}

/* UX additions */
.chipBtn{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  color: rgba(255,255,255,.86);
  cursor:pointer;
}
.chipBtn:hover{ transform: translateY(-1px); }
.chipBtn:active{ transform: translateY(0px); }
.chipBtn.on{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
.chipBtn.off{ opacity:.75; }
.chipBtn.small{ padding:5px 9px; font-size:12px; }

details.advDetails > summary{
  cursor:pointer;
  list-style:none;
}
details.advDetails > summary::-webkit-details-marker { display:none; }

.modalBackdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  z-index: 50;
}
.modalBackdrop.show{ display:flex; }
.modalCard{
  width:min(720px, calc(100vw - 24px));
  max-height: min(80vh, 720px);
  overflow:auto;
  background: rgba(20,22,26,.96);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:14px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
}
.modalGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}
@media (max-width:640px){
  .modalGrid{ grid-template-columns: 1fr; }
}
.colGroupTitle{ font-weight:900; margin-top:8px; }
.colItem{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:12px; }
.colItem:hover{ background: rgba(255,255,255,.06); }

</style><style id="colHideStyle">th[data-col="tag"], td[data-col="tag"]{display:none !important;}</style>
</head>
<body>
<header class="suiteHeader">
<div class="suiteHeader__left">
<div class="suiteHeader__topline">
<div class="suiteHeader__title">AMP Anomaly Finder</div>
<div class="suiteHeader__pill"><span id="buildTagPill">v4.0.2 OFFLINE-PORTABLE-REFACTOR</span></div>
<div class="suiteHeader__pill suiteHeader__pill--muted">offline</div>
</div>
<div class="suiteHeader__tagline">Upload AMP “Press” CSV exports. Scores anomalies + explainable causes.</div>
</div>
<div class="suiteHeader__right">
<div class="suiteHeader__actions">
<button class="btn secondary" id="btnExport">Export shown (CSV)</button>
<div class="menuWrap" style="position:relative">
<button aria-expanded="false" aria-haspopup="true" class="btn secondary" id="btnMore" title="More actions" type="button">⋯</button>
<div aria-label="More actions" class="menu" id="moreMenu" role="menu" style="display:none">
<button class="menuItem" id="miExportJSON" type="button">Export .json</button>
<button class="menuItem" id="miImportJSON" type="button">Import .json</button>
<button class="menuItem" id="miSelfTest" type="button">Offline self-test</button>
<button class="menuItem" id="miPortable" type="button">Portable bundle</button>
<div class="menuSep"></div>
<button class="menuItem" id="miCopy" type="button">Copy shown</button>
<button class="menuItem" id="miClearSort" type="button">Clear sort</button>
<button class="menuItem" id="miReset" type="button">Reset defaults</button>
<div class="menuSep"></div>
<button class="menuItem danger" id="miClear" type="button">Clear</button>
</div>
</div>
<button aria-hidden="true" class="btn secondary" id="btnExportJSON" style="display:none">Export .json</button>
<button aria-hidden="true" class="btn secondary" id="btnImportJSON" style="display:none">Import .json</button>
<button aria-hidden="true" class="btn secondary" id="btnCopy" style="display:none">Copy shown</button>
<button aria-hidden="true" class="btn secondary" id="btnClearSort" style="display: none; opacity: 0.55;" disabled="">Clear sort</button>
<button aria-hidden="true" class="btn secondary" id="btnReset" style="display:none">Reset defaults</button>
<button aria-hidden="true" class="btn secondary" id="btnClear" style="display:none">Clear</button>
<input accept=".json,application/json" id="jsonIn" style="display:none" type="file">
<input accept=".json,application/json" id="portableIn" style="display:none" type="file">
</div>
<div class="suiteHeader__badge suiteHeader__badge--img" title="Target"><img alt="Target" src="data:image/jpeg;base64,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"></div>
</div>
</header>
<main>
<section class="card">
<h2>Upload &amp; Controls</h2>
<div class="body">
<div class="wizard" id="wizard" style="margin-bottom:10px">
<div class="wizStep active" data-step="1"><span class="wizDot"></span><span><strong>1</strong> Upload</span></div>
<div class="wizStep" data-step="2"><span class="wizDot"></span><span><strong>2</strong> Detected</span></div>
<div class="wizStep" data-step="3"><span class="wizDot"></span><span><strong>3</strong> Review anomalies</span></div>
<div class="wizStep" data-step="4"><span class="wizDot"></span><span><strong>4</strong> Export / save</span></div>
</div>
<div class="row">
<label class="btn" for="fileIn">Choose files</label>
<input accept=".csv,text/csv" id="fileIn" multiple="" type="file">
</div>
<div class="drop" id="drop" style="margin-top:10px">
<strong>Drop AMP CSV files here</strong><br>
<span class="small">Each file becomes a session. Works offline (no internet needed).</span>
</div>
<div class="card" id="detectSummary" style="margin-top: 10px; padding: 10px; display: none; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;">
<div class="row" style="justify-content:space-between; align-items:center; gap:10px">
<div>
<strong>Detected fields</strong>
<span class="small muted" id="detectSummaryTitle" style="margin-left:8px">Imported 1/1 file(s)</span>
</div>
<button class="btn secondary" id="btnClearDetect" type="button">Dismiss</button>
</div>
<div class="small" id="detectSummaryBody" style="margin-top:6px; line-height:1.35">
        <div style="padding:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; margin-top:10px; background:rgba(0,0,0,.14)">
          <div style="font-weight:900">17-Nov-2025 Lapua Virgin.csv</div>
          <div class="small muted" style="margin-top:4px">
            Rounds: <span class="mono">101</span> · 
          </div>
          <div class="small" style="margin-top:6px">
            Metrics: ✅ <span class="chip">Peak Force</span> <span class="chip">Work Done</span> <span class="chip">Starting Pos</span> <span class="chip">Terminal Force</span>
          </div>
          <div class="small" style="margin-top:6px">
            Diagnostics: </div>
        </div>
      <div class="hint" style="margin-top:10px">
        Next: choose a session, review highlighted rows, then use <span class="chip">Export shown</span> when you're ready.
      </div></div>
</div>
<div class="control" style="margin-top:12px">
<label>Session</label>
<select id="sessionSel"><option value="0">17-Nov-2025 Lapua Virgin.csv (101 rounds)</option></select>
<div class="hint" style="margin-top:6px">
          Tip: AMP export is often <span class="mono">wide</span> (variables in rows, <span class="mono">Trace 1..N</span> in columns). This tool expects that.
        </div>
</div><div class="control"><label>Preset</label><select id="presetSel"><option value="default">Default</option><option value="strict">Strict (fewer flags)</option><option value="sensitive">Sensitive (more flags)</option></select><div class="hint" style="margin-top:6px">Presets adjust threshold + filtering defaults. You can still fine-tune anything below.</div></div>
<div class="control">
<label>Anomaly threshold: <span class="mono" id="thVal">2.50</span></label>
<input id="th" max="5.0" min="0.5" step="0.05" type="range" value="2.5">
<div class="tog"><input id="onlyAnom" type="checkbox"><label for="onlyAnom">Only anomalies</label></div>
<div class="tog"><input id="onlyActionable" type="checkbox"><label for="onlyActionable" title="Shows Score ≥ threshold OR Flyer OR Excluded">Only actionable</label></div>
<details class="advDetails" id="advDetails" style="margin-top:12px"><summary class="hint">Advanced controls (click)</summary><div class="advBody" style="margin-top:10px"><div class="control">
<label>Peak Force ES limit (lb): <span class="mono" id="esVal">20</span></label>
<input id="es" max="50" min="5" step="1" type="range" value="20">
<div class="tog"><input checked="" id="esAuto" type="checkbox"><label for="esAuto">Auto-exclude ES extremes (top/bottom) when limit exceeded</label></div>
<div class="hint" style="margin-top:6px">
          ES here is <span class="mono">max(peak)-min(peak)</span> for the session. If it exceeds the limit, the max and min traces are marked <span class="mono">Excluded</span> but remain visible for learning.
        </div>
</div><div class="control">
<div class="tog"><input id="hideEx" type="checkbox"><label for="hideEx">Hide excluded rounds</label></div>
</div><div class="row" id="quickChips" style="gap:8px; flex-wrap:wrap; margin-top:10px"><button class="chipBtn small off" id="chipActionable" title="Score ≥ threshold OR Flyer OR Excluded" type="button">Actionable</button><button class="chipBtn small off" id="chipAnom" title="Score ≥ threshold" type="button">Anomalies</button><button class="chipBtn small off" id="chipFlyers" title="Only traces flagged as mechanical outliers" type="button">Flyers</button><button class="chipBtn small off" id="chipHideEx" title="Hide traces excluded by ES rule (or manual)" type="button">Hide excluded</button></div></div></details>
</div>
<div class="control">
<label>Search</label>
<input id="q" placeholder="trace, driver, cause…" type="text">
</div>
<div class="control">
<div class="split">
<div>
<label>Sort</label>
<select id="sortSel">
<option value="custom">Custom (header click)</option>
<option value="score_desc">Score (high → low)</option>
<option value="score_asc">Score (low → high)</option>
<option value="trace_asc">Trace (asc)</option>
<option value="trace_desc">Trace (desc)</option>
<option value="peak_desc">Peak Force (high → low)</option>
<option value="work_desc">Work Done (high → low)</option>
<option value="rough_desc">Roughness (high → low)</option>
</select>
</div>
<div>
<label>Baseline</label>
<select id="baseSel">
<option value="none">No baseline</option>
<option value="active">Active session</option>
<option value="custom">Saved baseline</option>
</select>
<div class="row" style="margin-top:8px">
<button class="btn secondary" id="btnSaveBase" title="Save the active session medians as baseline">Save baseline</button>
<button class="btn secondary" id="btnClrBase" title="Clear saved baseline">Clear</button>
</div>
</div>
</div>
<div class="hint" style="margin-top:8px">
          Baseline enables “Steeper slope overall” style detection by comparing session medians to your baseline.
        </div>
</div>
<div class="control">
<div class="kv">
<div>Rounds</div><div class="mono" id="kN">—</div>
<div>Anomalies (≥ threshold)</div><div class="mono" id="kA">—</div>
<div>Flyers</div><div class="mono" id="kF">—</div>
</div>
</div>
<div class="control">
<div class="badges">
<span class="badge"><span class="dot good"></span> Normal</span>
<span class="badge"><span class="dot mid"></span> Moderate</span>
<span class="badge"><span class="dot warn"></span> High</span>
<span class="badge"><span class="dot bad"></span> Flyer</span>
</div>
</div>
<div class="control" style="margin-top:12px">
</div>
</div>
</section>
<section class="card">
<h2>Rounds</h2>
<div class="sessionBar">
<div class="sessionPill" style="flex:1">
<span class="chip">Session</span>
<span class="label" id="sessLabel" title="—">—</span>
<span class="meta" id="sessMeta">—</span>
</div>
<div class="viewTabs" style="margin-left:auto">
<button class="tabbtn active" id="tabRounds" type="button">Rounds</button>
<button class="tabbtn" id="tabSessions" type="button">Sessions</button>
</div>
<span class="chip" id="baseChip">Baseline: none</span>
<span class="chip" id="showChip">Shown: —</span>
<span class="chip" id="filterChip" style="display:none">Filters: —</span>
</div>
<div class="warnBox" id="empty" style="display: block;">
      Upload one or more AMP CSV files to see a scored table here.
      <div class="hint">If your AMP export layout is different, paste a few header lines and I’ll adapt the parser.</div>
</div>
<div class="tableWrap" id="tableWrap" style="display: none;">
<div class="card" id="traceChartCard" style="margin-bottom:12px">
<div class="row" style="justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
<div>
<div class="kTitle">Trace chart</div>
<div class="hint">Peak Force by trace index. Highlights: <span class="mono">Flyer</span>, <span class="mono">Top5</span>/<span class="mono">Bottom5</span>, and <span class="mono">Excluded</span>.</div>
</div>
<div class="row" style="gap:10px; flex-wrap:wrap; justify-content:flex-end">
<label class="row small" style="gap:6px; cursor:pointer"><input id="tcOverlayWork" type="checkbox"> Overlay Work Done</label>
<label class="row small" style="gap:6px; cursor:pointer"><input id="tcUseFiltered" type="checkbox"> Use filtered view</label>
<label class="row small" style="gap:6px; cursor:pointer"><input checked="" id="tcShowExcluded" type="checkbox"> Show excluded</label>
</div>
</div>
<div class="card" style="margin-top:10px; padding:10px; background:rgba(0,0,0,.12)">
<canvas height="240" id="traceChart" style="width:100%; height:240px" width="900"></canvas>
<div class="hint" style="margin-top:6px">Tip: click column headers to sort; chart updates for the active session.</div>
</div>
</div>
<div class="card" id="inspectorWrap" style="margin-top:10px; padding:10px; background:rgba(0,0,0,.12); display:none">
<div class="row" style="justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
<strong id="insTitle">Selected trace</strong>
<span class="badge" id="insBucket" title="Bucket classification for this trace"></span>
</div>
<div class="row" style="gap:8px; flex-wrap:wrap">
<button class="btn secondary" id="btnInsPrev" title="Select previous shown row" type="button">Prev</button>
<button class="btn secondary" id="btnInsNext" title="Select next shown row" type="button">Next</button>
<button class="btn secondary" id="btnInsClear" type="button">Clear</button>
</div>
</div>
<div style="display:grid; grid-template-columns: 1.15fr 0.85fr; gap:12px; margin-top:10px">
<div>
<div class="small"><span class="muted">Score</span> <span class="mono" id="insScore">—</span> <span class="muted">•</span> <span class="muted">Driver</span> <span id="insDriver">—</span></div>
<div class="small" style="margin-top:6px"><span class="muted">Cause</span> <span id="insCause">—</span></div>
<div class="small" style="margin-top:6px"><span class="muted">Why</span> <span id="insWhy">—</span></div>
<div class="small" style="margin-top:6px"><span class="muted">Values</span> <span class="mono" id="insVals">—</span></div>
</div>
<div>
<label class="tog" style="display:flex; align-items:center; gap:8px">
<input id="insUserExcluded" type="checkbox">
<span>Manually excluded</span>
</label>
<div class="small muted" id="insExcludedWhy" style="margin-top:6px">—</div>
<div class="row" style="gap:8px; margin-top:10px; align-items:center">
<input id="insTag" placeholder="Add a note tag (saved in JSON export)" style="flex:1; min-width:160px" type="text">
<button class="btn secondary" id="btnInsTagSave" type="button">Save</button>
<button class="btn secondary" id="btnInsTagClear" type="button">Clear</button>
</div>
<div class="small" style="margin-top:8px"><span class="muted">Tags</span> <span id="insTags">—</span></div>
</div>
</div>
<div class="small" style="margin-top:12px"><strong>Z breakdown</strong> <span class="muted">(standard deviations)</span></div>
<div class="small mono" id="insZ" style="margin-top:6px; white-space:pre-wrap; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px">—</div><div class="hint" id="insAdvice" style="margin-top:10px; padding:10px; border-radius:14px; background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.08)">—</div>
</div>
<table>
<thead>
<tr>
<th data-col="trace" style="cursor: pointer;" title="Click to sort">Trace</th>
<th data-col="flyer" style="cursor: pointer;" title="Click to sort">Flyer</th>
<th data-col="excluded" style="cursor: pointer;" title="Click to sort">Excluded</th>
<th data-col="tag" style="cursor: pointer;" title="Click to sort">Tag</th>
<th data-col="why">Why</th>
<th data-col="cause" style="cursor: pointer;" title="Click to sort">Cause</th>
<th data-col="conf" style="cursor: pointer;" title="Click to sort">Conf</th>
<th data-col="score" style="cursor: pointer;" title="Click to sort">Score</th>
<th data-col="driver">Driver</th>
<th class="nowrap" data-col="peak" style="cursor: pointer;" title="Click to sort">Peak Force</th>
<th class="nowrap" data-col="work" style="cursor: pointer;" title="Click to sort">Work Done</th>
</tr>
</thead>
<tbody id="tbody"><tr class="flyer  " data-idx="0" data-traceindex="20">
      <td class="mono" data-col="trace">Trace 20</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot bad"></span>true</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five HIGHEST Peak Force traces in this session"><span class="dot good"></span>Top5</span></td>
      <td data-col="why"><span title="Work Done +3.54σ • Peak Force +2.98σ • Terminal Force +2.75σ"><span class="badge" title="Flyer: this trace is a mechanical outlier vs the session baseline (robust outlier test). Consider segregating or re-prepping."><span class="dot bad"></span>Flyer</span> <span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Work Done +3.54σ • Peak Force +2.98σ • Terminal Force +2.75σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">3.55</td>
      <td data-col="driver">Work Done (3.54σ)</td>
      <td class="mono" data-col="peak">57.349</td>
      <td class="mono" data-col="work">7.066</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">57.349</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="high  " data-idx="1" data-traceindex="51">
      <td class="mono" data-col="trace">Trace 51</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five HIGHEST Peak Force traces in this session"><span class="dot good"></span>Top5</span></td>
      <td data-col="why"><span title="Work Done +3.49σ • Peak Force +3.09σ • Terminal Force +2.85σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Work Done +3.49σ • Peak Force +3.09σ • Terminal Force +2.85σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">2.70</td>
      <td data-col="driver">Work Done (3.49σ)</td>
      <td class="mono" data-col="peak">57.764</td>
      <td class="mono" data-col="work">7.044</td>
      <td class="mono" data-col="startPos">0.160</td>
      <td class="mono" data-col="termForce">57.764</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="2" data-traceindex="89">
      <td class="mono" data-col="trace">Trace 89</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five HIGHEST Peak Force traces in this session"><span class="dot good"></span>Top5</span></td>
      <td data-col="why"><span title="Work Done +3.16σ • Peak Force +2.64σ • Terminal Force +2.44σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Work Done +3.16σ • Peak Force +2.64σ • Terminal Force +2.44σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">2.16</td>
      <td data-col="driver">Work Done (3.16σ)</td>
      <td class="mono" data-col="peak">56.103</td>
      <td class="mono" data-col="work">6.903</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">56.103</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="3" data-traceindex="30">
      <td class="mono" data-col="trace">Trace 30</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five HIGHEST Peak Force traces in this session"><span class="dot good"></span>Top5</span></td>
      <td data-col="why"><span title="Work Done +2.89σ • Peak Force +2.53σ • Terminal Force +2.33σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Work Done +2.89σ • Peak Force +2.53σ • Terminal Force +2.33σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">2.11</td>
      <td data-col="driver">Work Done (2.89σ)</td>
      <td class="mono" data-col="peak">55.687</td>
      <td class="mono" data-col="work">6.790</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">55.687</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="4" data-traceindex="10">
      <td class="mono" data-col="trace">Trace 10</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five HIGHEST Peak Force traces in this session"><span class="dot good"></span>Top5</span></td>
      <td data-col="why"><span title="Peak Force +2.59σ • Terminal Force +2.39σ • Work Done +2.17σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Peak Force +2.59σ • Terminal Force +2.39σ • Work Done +2.17σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">2.02</td>
      <td data-col="driver">Peak Force (2.59σ)</td>
      <td class="mono" data-col="peak">55.895</td>
      <td class="mono" data-col="work">6.489</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">55.895</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="5" data-traceindex="62">
      <td class="mono" data-col="trace">Trace 62</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Peak Force +2.53σ • Terminal Force +2.33σ • Work Done +2.13σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Peak Force +2.53σ • Terminal Force +2.33σ • Work Done +2.13σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">1.91</td>
      <td data-col="driver">Peak Force (2.53σ)</td>
      <td class="mono" data-col="peak">55.687</td>
      <td class="mono" data-col="work">6.471</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">55.687</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="6" data-traceindex="53">
      <td class="mono" data-col="trace">Trace 53</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Work Done +1.93σ • Peak Force +1.46σ • Terminal Force +1.35σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Work Done +1.93σ • Peak Force +1.46σ • Terminal Force +1.35σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.90</td>
      <td data-col="driver">Starting Pos (3.04σ)</td>
      <td class="mono" data-col="peak">51.742</td>
      <td class="mono" data-col="work">6.387</td>
      <td class="mono" data-col="startPos">0.166</td>
      <td class="mono" data-col="termForce">51.742</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="7" data-traceindex="48">
      <td class="mono" data-col="trace">Trace 48</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Peak Force +2.42σ • Terminal Force +2.23σ • Work Done +2.02σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Peak Force +2.42σ • Terminal Force +2.23σ • Work Done +2.02σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">1.90</td>
      <td data-col="driver">Peak Force (2.42σ)</td>
      <td class="mono" data-col="peak">55.272</td>
      <td class="mono" data-col="work">6.423</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">55.272</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="8" data-traceindex="66">
      <td class="mono" data-col="trace">Trace 66</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Work Done +2.44σ • Peak Force +1.97σ • Terminal Force +1.82σ"><span class="badge" title="Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score)."><span class="dot warn"></span>Force outlier</span></span></td>
      <td data-col="cause"><span title="Work Done +2.44σ • Peak Force +1.97σ • Terminal Force +1.82σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot warn"></span>med</span></td>
      <td class="mono" data-col="score">1.78</td>
      <td data-col="driver">Work Done (2.44σ)</td>
      <td class="mono" data-col="peak">53.611</td>
      <td class="mono" data-col="work">6.602</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">53.611</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="moderate  " data-idx="9" data-traceindex="88">
      <td class="mono" data-col="trace">Trace 88</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Work Done +1.91σ • Peak Force +1.85σ • Terminal Force +1.71σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Work Done +1.91σ • Peak Force +1.85σ • Terminal Force +1.71σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.58</td>
      <td data-col="driver">Work Done (1.91σ)</td>
      <td class="mono" data-col="peak">53.195</td>
      <td class="mono" data-col="work">6.377</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">53.195</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="10" data-traceindex="90">
      <td class="mono" data-col="trace">Trace 90</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five LOWEST Peak Force traces in this session"><span class="dot mid"></span>Bottom5</span></td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.47</td>
      <td data-col="driver">Peak Force (1.69σ)</td>
      <td class="mono" data-col="peak">40.113</td>
      <td class="mono" data-col="work">5.094</td>
      <td class="mono" data-col="startPos">0.153</td>
      <td class="mono" data-col="termForce">39.697</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="11" data-traceindex="87">
      <td class="mono" data-col="trace">Trace 87</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.46</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">51.949</td>
      <td class="mono" data-col="work">6.107</td>
      <td class="mono" data-col="startPos">0.152</td>
      <td class="mono" data-col="termForce">51.949</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="12" data-traceindex="37">
      <td class="mono" data-col="trace">Trace 37</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Work Done +2.00σ • Peak Force +1.63σ • Terminal Force +1.50σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Work Done +2.00σ • Peak Force +1.63σ • Terminal Force +1.50σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.42</td>
      <td data-col="driver">Work Done (2.00σ)</td>
      <td class="mono" data-col="peak">52.365</td>
      <td class="mono" data-col="work">6.415</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">52.365</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="13" data-traceindex="29">
      <td class="mono" data-col="trace">Trace 29</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Peak Force +1.91σ • Terminal Force +1.76σ • Work Done +1.72σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Peak Force +1.91σ • Terminal Force +1.76σ • Work Done +1.72σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.42</td>
      <td data-col="driver">Peak Force (1.91σ)</td>
      <td class="mono" data-col="peak">53.403</td>
      <td class="mono" data-col="work">6.299</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">53.403</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="14" data-traceindex="44">
      <td class="mono" data-col="trace">Trace 44</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.33</td>
      <td data-col="driver">Peak Force (1.80σ)</td>
      <td class="mono" data-col="peak">52.988</td>
      <td class="mono" data-col="work">6.019</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">52.988</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="15" data-traceindex="3">
      <td class="mono" data-col="trace">Trace 3</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.33</td>
      <td data-col="driver">Work Done (1.59σ)</td>
      <td class="mono" data-col="peak">51.949</td>
      <td class="mono" data-col="work">6.243</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">51.949</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="16" data-traceindex="64">
      <td class="mono" data-col="trace">Trace 64</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five LOWEST Peak Force traces in this session"><span class="dot mid"></span>Bottom5</span></td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.25</td>
      <td data-col="driver">Peak Force (1.46σ)</td>
      <td class="mono" data-col="peak">40.943</td>
      <td class="mono" data-col="work">5.018</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">40.528</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="17" data-traceindex="84">
      <td class="mono" data-col="trace">Trace 84</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.19</td>
      <td data-col="driver">Work Done (1.33σ)</td>
      <td class="mono" data-col="peak">41.774</td>
      <td class="mono" data-col="work">5.016</td>
      <td class="mono" data-col="startPos">0.160</td>
      <td class="mono" data-col="termForce">41.774</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="18" data-traceindex="96">
      <td class="mono" data-col="trace">Trace 96</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five LOWEST Peak Force traces in this session"><span class="dot mid"></span>Bottom5</span></td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.18</td>
      <td data-col="driver">Peak Force (1.29σ)</td>
      <td class="mono" data-col="peak">41.566</td>
      <td class="mono" data-col="work">5.072</td>
      <td class="mono" data-col="startPos">0.160</td>
      <td class="mono" data-col="termForce">41.566</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="19" data-traceindex="99">
      <td class="mono" data-col="trace">Trace 99</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five LOWEST Peak Force traces in this session"><span class="dot mid"></span>Bottom5</span></td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.18</td>
      <td data-col="driver">Work Done (1.42σ)</td>
      <td class="mono" data-col="peak">41.566</td>
      <td class="mono" data-col="work">4.976</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">41.359</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="20" data-traceindex="50">
      <td class="mono" data-col="trace">Trace 50</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Work Done +1.89σ • Peak Force +1.29σ • Terminal Force +1.19σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Work Done +1.89σ • Peak Force +1.29σ • Terminal Force +1.19σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.15</td>
      <td data-col="driver">Work Done (1.89σ)</td>
      <td class="mono" data-col="peak">51.119</td>
      <td class="mono" data-col="work">6.368</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">51.119</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="21" data-traceindex="19">
      <td class="mono" data-col="trace">Trace 19</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.13</td>
      <td data-col="driver">Peak Force (1.41σ)</td>
      <td class="mono" data-col="peak">51.534</td>
      <td class="mono" data-col="work">6.133</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">51.534</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="22" data-traceindex="13">
      <td class="mono" data-col="trace">Trace 13</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.09</td>
      <td data-col="driver">Work Done (1.26σ)</td>
      <td class="mono" data-col="peak">50.288</td>
      <td class="mono" data-col="work">6.103</td>
      <td class="mono" data-col="startPos">0.154</td>
      <td class="mono" data-col="termForce">50.288</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="23" data-traceindex="34">
      <td class="mono" data-col="trace">Trace 34</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.04</td>
      <td data-col="driver">Peak Force (1.63σ)</td>
      <td class="mono" data-col="peak">52.365</td>
      <td class="mono" data-col="work">5.919</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">52.365</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="24" data-traceindex="93">
      <td class="mono" data-col="trace">Trace 93</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.03</td>
      <td data-col="driver">Work Done (1.44σ)</td>
      <td class="mono" data-col="peak">42.604</td>
      <td class="mono" data-col="work">4.969</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">42.604</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="25" data-traceindex="47">
      <td class="mono" data-col="trace">Trace 47</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="Peak Force +1.91σ • Terminal Force +1.76σ"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="Peak Force +1.91σ • Terminal Force +1.76σ">Neck tension / sizing / anneal variance</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot mid"></span>low</span></td>
      <td class="mono" data-col="score">1.03</td>
      <td data-col="driver">Peak Force (1.91σ)</td>
      <td class="mono" data-col="peak">53.403</td>
      <td class="mono" data-col="work">5.670</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">53.403</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="26" data-traceindex="6">
      <td class="mono" data-col="trace">Trace 6</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.03</td>
      <td data-col="driver">Peak Force (1.35σ)</td>
      <td class="mono" data-col="peak">51.326</td>
      <td class="mono" data-col="work">6.127</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">51.326</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="27" data-traceindex="60">
      <td class="mono" data-col="trace">Trace 60</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.02</td>
      <td data-col="driver">Work Done (1.50σ)</td>
      <td class="mono" data-col="peak">41.774</td>
      <td class="mono" data-col="work">4.942</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">41.774</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="28" data-traceindex="83">
      <td class="mono" data-col="trace">Trace 83</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.00</td>
      <td data-col="driver">Work Done (1.37σ)</td>
      <td class="mono" data-col="peak">43.227</td>
      <td class="mono" data-col="work">4.996</td>
      <td class="mono" data-col="startPos">0.154</td>
      <td class="mono" data-col="termForce">43.227</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="29" data-traceindex="63">
      <td class="mono" data-col="trace">Trace 63</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">1.00</td>
      <td data-col="driver">Starting Pos (2.36σ)</td>
      <td class="mono" data-col="peak">44.473</td>
      <td class="mono" data-col="work">5.201</td>
      <td class="mono" data-col="startPos">0.150</td>
      <td class="mono" data-col="termForce">44.473</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="30" data-traceindex="72">
      <td class="mono" data-col="trace">Trace 72</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.98</td>
      <td data-col="driver">Terminal Force (1.24σ)</td>
      <td class="mono" data-col="peak">41.774</td>
      <td class="mono" data-col="work">5.152</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">41.359</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="31" data-traceindex="38">
      <td class="mono" data-col="trace">Trace 38</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.98</td>
      <td data-col="driver">Starting Pos (2.36σ)</td>
      <td class="mono" data-col="peak">45.096</td>
      <td class="mono" data-col="work">5.087</td>
      <td class="mono" data-col="startPos">0.150</td>
      <td class="mono" data-col="termForce">45.096</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="32" data-traceindex="33">
      <td class="mono" data-col="trace">Trace 33</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.94</td>
      <td data-col="driver">Peak Force (1.46σ)</td>
      <td class="mono" data-col="peak">51.742</td>
      <td class="mono" data-col="work">5.782</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">51.742</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="33" data-traceindex="28">
      <td class="mono" data-col="trace">Trace 28</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.94</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">48.419</td>
      <td class="mono" data-col="work">6.055</td>
      <td class="mono" data-col="startPos">0.162</td>
      <td class="mono" data-col="termForce">48.211</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="34" data-traceindex="8">
      <td class="mono" data-col="trace">Trace 8</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.93</td>
      <td data-col="driver">Peak Force (1.18σ)</td>
      <td class="mono" data-col="peak">50.703</td>
      <td class="mono" data-col="work">5.870</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">50.703</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="35" data-traceindex="100">
      <td class="mono" data-col="trace">Trace 100</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.92</td>
      <td data-col="driver">Starting Pos (1.35σ)</td>
      <td class="mono" data-col="peak">43.643</td>
      <td class="mono" data-col="work">5.177</td>
      <td class="mono" data-col="startPos">0.153</td>
      <td class="mono" data-col="termForce">43.435</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="36" data-traceindex="49">
      <td class="mono" data-col="trace">Trace 49</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.90</td>
      <td data-col="driver">Work Done (1.09σ)</td>
      <td class="mono" data-col="peak">50.288</td>
      <td class="mono" data-col="work">6.032</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">50.288</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="37" data-traceindex="11">
      <td class="mono" data-col="trace">Trace 11</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.89</td>
      <td data-col="driver">Peak Force (1.12σ)</td>
      <td class="mono" data-col="peak">50.496</td>
      <td class="mono" data-col="work">5.736</td>
      <td class="mono" data-col="startPos">0.154</td>
      <td class="mono" data-col="termForce">50.496</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="38" data-traceindex="61">
      <td class="mono" data-col="trace">Trace 61</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.88</td>
      <td data-col="driver">Starting Pos (2.02σ)</td>
      <td class="mono" data-col="peak">44.473</td>
      <td class="mono" data-col="work">5.278</td>
      <td class="mono" data-col="startPos">0.151</td>
      <td class="mono" data-col="termForce">44.473</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="39" data-traceindex="91">
      <td class="mono" data-col="trace">Trace 91</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.85</td>
      <td data-col="driver">Peak Force (1.07σ)</td>
      <td class="mono" data-col="peak">50.288</td>
      <td class="mono" data-col="work">5.717</td>
      <td class="mono" data-col="startPos">0.154</td>
      <td class="mono" data-col="termForce">50.288</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="40" data-traceindex="79">
      <td class="mono" data-col="trace">Trace 79</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.84</td>
      <td data-col="driver">Peak Force (1.07σ)</td>
      <td class="mono" data-col="peak">50.288</td>
      <td class="mono" data-col="work">5.814</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">50.288</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="41" data-traceindex="101">
      <td class="mono" data-col="trace">Trace 101</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.83</td>
      <td data-col="driver">Peak Force (1.18σ)</td>
      <td class="mono" data-col="peak">50.703</td>
      <td class="mono" data-col="work">5.833</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">50.703</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="42" data-traceindex="94">
      <td class="mono" data-col="trace">Trace 94</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.82</td>
      <td data-col="driver">Peak Force (1.12σ)</td>
      <td class="mono" data-col="peak">50.496</td>
      <td class="mono" data-col="work">5.867</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">50.496</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="43" data-traceindex="16">
      <td class="mono" data-col="trace">Trace 16</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.81</td>
      <td data-col="driver">Peak Force (0.96σ)</td>
      <td class="mono" data-col="peak">42.812</td>
      <td class="mono" data-col="work">5.282</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">42.812</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="44" data-traceindex="77">
      <td class="mono" data-col="trace">Trace 77</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.79</td>
      <td data-col="driver">Peak Force (1.01σ)</td>
      <td class="mono" data-col="peak">50.080</td>
      <td class="mono" data-col="work">5.902</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">50.080</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="45" data-traceindex="41">
      <td class="mono" data-col="trace">Trace 41</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.79</td>
      <td data-col="driver">Starting Pos (1.01σ)</td>
      <td class="mono" data-col="peak">43.020</td>
      <td class="mono" data-col="work">5.392</td>
      <td class="mono" data-col="startPos">0.160</td>
      <td class="mono" data-col="termForce">43.020</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="46" data-traceindex="52">
      <td class="mono" data-col="trace">Trace 52</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag"><span class="badge" title="Tag: one of the five LOWEST Peak Force traces in this session"><span class="dot mid"></span>Bottom5</span></td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.78</td>
      <td data-col="driver">Peak Force (1.35σ)</td>
      <td class="mono" data-col="peak">41.359</td>
      <td class="mono" data-col="work">5.415</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">41.359</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="47" data-traceindex="97">
      <td class="mono" data-col="trace">Trace 97</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.76</td>
      <td data-col="driver">Work Done (1.10σ)</td>
      <td class="mono" data-col="peak">43.435</td>
      <td class="mono" data-col="work">5.110</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">43.435</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="48" data-traceindex="95">
      <td class="mono" data-col="trace">Trace 95</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.75</td>
      <td data-col="driver">Starting Pos (2.02σ)</td>
      <td class="mono" data-col="peak">45.719</td>
      <td class="mono" data-col="work">5.199</td>
      <td class="mono" data-col="startPos">0.151</td>
      <td class="mono" data-col="termForce">45.719</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="49" data-traceindex="92">
      <td class="mono" data-col="trace">Trace 92</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.75</td>
      <td data-col="driver">Work Done (1.00σ)</td>
      <td class="mono" data-col="peak">43.850</td>
      <td class="mono" data-col="work">5.152</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">43.850</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="50" data-traceindex="4">
      <td class="mono" data-col="trace">Trace 4</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.71</td>
      <td data-col="driver">Peak Force (0.96σ)</td>
      <td class="mono" data-col="peak">49.873</td>
      <td class="mono" data-col="work">5.944</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">49.873</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="51" data-traceindex="65">
      <td class="mono" data-col="trace">Trace 65</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.71</td>
      <td data-col="driver">Work Done (0.96σ)</td>
      <td class="mono" data-col="peak">48.627</td>
      <td class="mono" data-col="work">5.978</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">48.627</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="52" data-traceindex="98">
      <td class="mono" data-col="trace">Trace 98</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.71</td>
      <td data-col="driver">Peak Force (1.01σ)</td>
      <td class="mono" data-col="peak">50.080</td>
      <td class="mono" data-col="work">5.491</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">50.080</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="53" data-traceindex="21">
      <td class="mono" data-col="trace">Trace 21</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.66</td>
      <td data-col="driver">Starting Pos (1.01σ)</td>
      <td class="mono" data-col="peak">44.266</td>
      <td class="mono" data-col="work">5.315</td>
      <td class="mono" data-col="startPos">0.154</td>
      <td class="mono" data-col="termForce">44.266</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="54" data-traceindex="22">
      <td class="mono" data-col="trace">Trace 22</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.66</td>
      <td data-col="driver">Starting Pos (1.35σ)</td>
      <td class="mono" data-col="peak">45.096</td>
      <td class="mono" data-col="work">5.251</td>
      <td class="mono" data-col="startPos">0.153</td>
      <td class="mono" data-col="termForce">45.096</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="55" data-traceindex="71">
      <td class="mono" data-col="trace">Trace 71</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.66</td>
      <td data-col="driver">Starting Pos (1.35σ)</td>
      <td class="mono" data-col="peak">43.850</td>
      <td class="mono" data-col="work">5.563</td>
      <td class="mono" data-col="startPos">0.161</td>
      <td class="mono" data-col="termForce">43.435</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="56" data-traceindex="70">
      <td class="mono" data-col="trace">Trace 70</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.65</td>
      <td data-col="driver">Starting Pos (1.35σ)</td>
      <td class="mono" data-col="peak">48.211</td>
      <td class="mono" data-col="work">5.743</td>
      <td class="mono" data-col="startPos">0.153</td>
      <td class="mono" data-col="termForce">48.211</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="57" data-traceindex="35">
      <td class="mono" data-col="trace">Trace 35</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.63</td>
      <td data-col="driver">Peak Force (0.79σ)</td>
      <td class="mono" data-col="peak">49.250</td>
      <td class="mono" data-col="work">5.855</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">49.042</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="58" data-traceindex="68">
      <td class="mono" data-col="trace">Trace 68</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.62</td>
      <td data-col="driver">Work Done (1.04σ)</td>
      <td class="mono" data-col="peak">44.889</td>
      <td class="mono" data-col="work">5.136</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">44.889</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="59" data-traceindex="25">
      <td class="mono" data-col="trace">Trace 25</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.61</td>
      <td data-col="driver">Work Done (0.67σ)</td>
      <td class="mono" data-col="peak">48.419</td>
      <td class="mono" data-col="work">5.858</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">48.419</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="60" data-traceindex="80">
      <td class="mono" data-col="trace">Trace 80</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.60</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">44.058</td>
      <td class="mono" data-col="work">5.340</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">44.058</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="61" data-traceindex="59">
      <td class="mono" data-col="trace">Trace 59</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.60</td>
      <td data-col="driver">Peak Force (0.84σ)</td>
      <td class="mono" data-col="peak">43.227</td>
      <td class="mono" data-col="work">5.408</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">43.227</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="62" data-traceindex="5">
      <td class="mono" data-col="trace">Trace 5</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.60</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">48.627</td>
      <td class="mono" data-col="work">5.806</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">48.627</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="63" data-traceindex="43">
      <td class="mono" data-col="trace">Trace 43</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.58</td>
      <td data-col="driver">Work Done (0.78σ)</td>
      <td class="mono" data-col="peak">48.004</td>
      <td class="mono" data-col="work">5.902</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">48.004</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="64" data-traceindex="69">
      <td class="mono" data-col="trace">Trace 69</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.58</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">46.550</td>
      <td class="mono" data-col="work">5.276</td>
      <td class="mono" data-col="startPos">0.152</td>
      <td class="mono" data-col="termForce">46.550</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="65" data-traceindex="32">
      <td class="mono" data-col="trace">Trace 32</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.56</td>
      <td data-col="driver">Peak Force (0.79σ)</td>
      <td class="mono" data-col="peak">43.435</td>
      <td class="mono" data-col="work">5.320</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">43.435</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="66" data-traceindex="36">
      <td class="mono" data-col="trace">Trace 36</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.55</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">46.135</td>
      <td class="mono" data-col="work">5.325</td>
      <td class="mono" data-col="startPos">0.152</td>
      <td class="mono" data-col="termForce">46.135</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="67" data-traceindex="55">
      <td class="mono" data-col="trace">Trace 55</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.52</td>
      <td data-col="driver">Peak Force (0.90σ)</td>
      <td class="mono" data-col="peak">43.020</td>
      <td class="mono" data-col="work">5.475</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">43.020</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="68" data-traceindex="39">
      <td class="mono" data-col="trace">Trace 39</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.51</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">44.681</td>
      <td class="mono" data-col="work">5.349</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">44.681</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="69" data-traceindex="15">
      <td class="mono" data-col="trace">Trace 15</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.49</td>
      <td data-col="driver">Peak Force (0.67σ)</td>
      <td class="mono" data-col="peak">48.834</td>
      <td class="mono" data-col="work">5.806</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">48.834</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="70" data-traceindex="17">
      <td class="mono" data-col="trace">Trace 17</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.47</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">46.758</td>
      <td class="mono" data-col="work">5.491</td>
      <td class="mono" data-col="startPos">0.152</td>
      <td class="mono" data-col="termForce">46.758</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="71" data-traceindex="56">
      <td class="mono" data-col="trace">Trace 56</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.45</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">45.096</td>
      <td class="mono" data-col="work">5.360</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">45.096</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="72" data-traceindex="26">
      <td class="mono" data-col="trace">Trace 26</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.44</td>
      <td data-col="driver">Starting Pos (1.35σ)</td>
      <td class="mono" data-col="peak">45.512</td>
      <td class="mono" data-col="work">5.638</td>
      <td class="mono" data-col="startPos">0.153</td>
      <td class="mono" data-col="termForce">45.512</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="73" data-traceindex="85">
      <td class="mono" data-col="trace">Trace 85</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.43</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">46.550</td>
      <td class="mono" data-col="work">5.505</td>
      <td class="mono" data-col="startPos">0.152</td>
      <td class="mono" data-col="termForce">46.550</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="74" data-traceindex="14">
      <td class="mono" data-col="trace">Trace 14</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.42</td>
      <td data-col="driver">Starting Pos (1.69σ)</td>
      <td class="mono" data-col="peak">46.135</td>
      <td class="mono" data-col="work">5.612</td>
      <td class="mono" data-col="startPos">0.162</td>
      <td class="mono" data-col="termForce">46.135</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="75" data-traceindex="45">
      <td class="mono" data-col="trace">Trace 45</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.41</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">47.796</td>
      <td class="mono" data-col="work">5.687</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">47.796</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="76" data-traceindex="18">
      <td class="mono" data-col="trace">Trace 18</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.41</td>
      <td data-col="driver">Work Done (0.70σ)</td>
      <td class="mono" data-col="peak">45.719</td>
      <td class="mono" data-col="work">5.280</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">45.719</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="77" data-traceindex="46">
      <td class="mono" data-col="trace">Trace 46</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.41</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">44.681</td>
      <td class="mono" data-col="work">5.512</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">44.681</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="78" data-traceindex="81">
      <td class="mono" data-col="trace">Trace 81</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.41</td>
      <td data-col="driver">Starting Pos (1.01σ)</td>
      <td class="mono" data-col="peak">45.304</td>
      <td class="mono" data-col="work">5.496</td>
      <td class="mono" data-col="startPos">0.160</td>
      <td class="mono" data-col="termForce">45.304</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="79" data-traceindex="75">
      <td class="mono" data-col="trace">Trace 75</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.41</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">47.173</td>
      <td class="mono" data-col="work">5.334</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">47.173</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="80" data-traceindex="12">
      <td class="mono" data-col="trace">Trace 12</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.40</td>
      <td data-col="driver">Peak Force (0.45σ)</td>
      <td class="mono" data-col="peak">44.681</td>
      <td class="mono" data-col="work">5.418</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">44.681</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="81" data-traceindex="2">
      <td class="mono" data-col="trace">Trace 2</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.39</td>
      <td data-col="driver">Work Done (0.91σ)</td>
      <td class="mono" data-col="peak">46.758</td>
      <td class="mono" data-col="work">5.957</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">45.512</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="82" data-traceindex="1">
      <td class="mono" data-col="trace">Trace 1</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.38</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">44.889</td>
      <td class="mono" data-col="work">5.635</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">44.889</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="83" data-traceindex="23">
      <td class="mono" data-col="trace">Trace 23</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.37</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">44.681</td>
      <td class="mono" data-col="work">5.574</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">44.681</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="84" data-traceindex="82">
      <td class="mono" data-col="trace">Trace 82</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.37</td>
      <td data-col="driver">Peak Force (0.56σ)</td>
      <td class="mono" data-col="peak">44.266</td>
      <td class="mono" data-col="work">5.438</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">44.266</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="85" data-traceindex="24">
      <td class="mono" data-col="trace">Trace 24</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.36</td>
      <td data-col="driver">Work Done (0.52σ)</td>
      <td class="mono" data-col="peak">44.681</td>
      <td class="mono" data-col="work">5.354</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">44.681</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="86" data-traceindex="67">
      <td class="mono" data-col="trace">Trace 67</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.34</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">45.719</td>
      <td class="mono" data-col="work">5.395</td>
      <td class="mono" data-col="startPos">0.155</td>
      <td class="mono" data-col="termForce">45.719</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="87" data-traceindex="74">
      <td class="mono" data-col="trace">Trace 74</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.28</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">45.304</td>
      <td class="mono" data-col="work">5.463</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">45.304</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="88" data-traceindex="54">
      <td class="mono" data-col="trace">Trace 54</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.26</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">45.512</td>
      <td class="mono" data-col="work">5.448</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">45.512</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="89" data-traceindex="42">
      <td class="mono" data-col="trace">Trace 42</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.25</td>
      <td data-col="driver">Starting Pos (0.67σ)</td>
      <td class="mono" data-col="peak">45.927</td>
      <td class="mono" data-col="work">5.643</td>
      <td class="mono" data-col="startPos">0.159</td>
      <td class="mono" data-col="termForce">45.927</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="90" data-traceindex="76">
      <td class="mono" data-col="trace">Trace 76</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.24</td>
      <td data-col="driver">Work Done (0.42σ)</td>
      <td class="mono" data-col="peak">46.342</td>
      <td class="mono" data-col="work">5.749</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">45.304</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="91" data-traceindex="86">
      <td class="mono" data-col="trace">Trace 86</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.24</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">46.965</td>
      <td class="mono" data-col="work">5.447</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">46.965</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="92" data-traceindex="27">
      <td class="mono" data-col="trace">Trace 27</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.19</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">45.719</td>
      <td class="mono" data-col="work">5.521</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">45.719</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="93" data-traceindex="78">
      <td class="mono" data-col="trace">Trace 78</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.19</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">47.173</td>
      <td class="mono" data-col="work">5.581</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">47.173</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="94" data-traceindex="58">
      <td class="mono" data-col="trace">Trace 58</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.17</td>
      <td data-col="driver">Work Done (0.39σ)</td>
      <td class="mono" data-col="peak">46.342</td>
      <td class="mono" data-col="work">5.737</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">46.342</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="95" data-traceindex="9">
      <td class="mono" data-col="trace">Trace 9</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.16</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">46.135</td>
      <td class="mono" data-col="work">5.671</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">46.135</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="96" data-traceindex="73">
      <td class="mono" data-col="trace">Trace 73</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.16</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">46.342</td>
      <td class="mono" data-col="work">5.714</td>
      <td class="mono" data-col="startPos">0.156</td>
      <td class="mono" data-col="termForce">46.342</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="97" data-traceindex="40">
      <td class="mono" data-col="trace">Trace 40</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.14</td>
      <td data-col="driver">Starting Pos (0.34σ)</td>
      <td class="mono" data-col="peak">46.550</td>
      <td class="mono" data-col="work">5.508</td>
      <td class="mono" data-col="startPos">0.158</td>
      <td class="mono" data-col="termForce">46.550</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="98" data-traceindex="7">
      <td class="mono" data-col="trace">Trace 7</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.12</td>
      <td data-col="driver">Work Done (0.46σ)</td>
      <td class="mono" data-col="peak">46.342</td>
      <td class="mono" data-col="work">5.380</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">46.342</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="99" data-traceindex="31">
      <td class="mono" data-col="trace">Trace 31</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.10</td>
      <td data-col="driver">Work Done (0.27σ)</td>
      <td class="mono" data-col="peak">46.135</td>
      <td class="mono" data-col="work">5.459</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">46.135</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr><tr class="normal  " data-idx="100" data-traceindex="57">
      <td class="mono" data-col="trace">Trace 57</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot good"></span>false</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot good"></span>false</span></td>
      <td data-col="tag">—</td>
      <td data-col="why"><span title="—"><span class="badge" title="Diagnostic flag"><span class="dot good"></span>—</span></span></td>
      <td data-col="cause"><span title="—">—</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot good"></span>—</span></td>
      <td class="mono" data-col="score">0.10</td>
      <td data-col="driver">Work Done (0.26σ)</td>
      <td class="mono" data-col="peak">46.135</td>
      <td class="mono" data-col="work">5.465</td>
      <td class="mono" data-col="startPos">0.157</td>
      <td class="mono" data-col="termForce">46.135</td>
      <td class="mono curveCol" data-col="earlySpike" title="Early spike: —">—</td>
      <td class="mono curveCol" data-col="jagged" title="Jaggedness: —">—</td>
      <td class="mono curveCol" data-col="endFlat" title="End flat: —">—</td>
      <td class="mono curveCol" data-col="endDrop" title="End drop: —">—</td>
    </tr></tbody>
</table>
</div>
<div class="sessionsWrap" id="sessionsWrap">
<div class="row" style="justify-content:space-between; align-items:center; margin:6px 0 10px">
<div class="small">Session summary across all loaded files. Click a session row to jump back to its rounds.</div>
<button class="btn secondary" id="btnExportSessions" title="Export session summary CSV" type="button">Export sessions (CSV)</button>
</div>
<table>
<thead>
<tr>
<th>Session</th>
<th>Rounds</th>
<th>Flyers</th>
<th>Anomalies</th>
</tr>
</thead>
<tbody id="sessionsTbody"></tbody>
</table>
</div>
</section>
</main>
<div aria-modal="true" class="modalBackdrop" id="colModal" role="dialog"><div class="modalCard"><div class="row" style="justify-content:space-between; align-items:center; gap:10px"><div><strong>Columns</strong><div class="small muted">Choose what shows in the Rounds table (saved locally).</div></div><button class="btn secondary" id="colCloseBtn" type="button">Close</button></div><div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px"><button class="btn secondary" id="colShowEssentials" title="Show the common “decision” columns" type="button">Essentials</button><button class="btn secondary" id="colShowAll" title="Show every column" type="button">Show all</button></div><div class="modalGrid" style="margin-top:10px"><div><div class="colGroupTitle">Core</div></div><div></div></div><div class="hint" style="margin-top:10px">Tip: you can also click column headers to sort.</div></div></div>

<div aria-modal="true" class="modalBackdrop" id="sysModal" role="dialog">
  <div class="modalCard">
    <div class="row" style="justify-content:space-between; align-items:center; gap:10px">
      <div>
        <strong>Offline &amp; Portable</strong>
        <div class="small muted">Self-test the offline build, and export/import a portable bundle (sessions + settings).</div>
      </div>
      <button class="btn secondary" id="sysCloseBtn" type="button">Close</button>
    </div>

    <div class="card" style="margin-top:12px; padding:12px">
      <div class="row" style="justify-content:space-between; align-items:center; gap:10px">
        <div>
          <strong>Offline self-test</strong>
          <div class="small muted">Checks for external references, storage access, and blocked network attempts.</div>
        </div>
        <button class="btn secondary" id="btnRunSelfTest" type="button">Run self-test</button>
      </div>
      <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
        <div class="tog"><input id="chkLockdown" type="checkbox" checked><label for="chkLockdown">Offline lockdown (block http/https/ws calls)</label></div>
      </div>
      <div id="sysResults" class="small" style="margin-top:10px; line-height:1.35"></div>
    </div>

    <div class="card" style="margin-top:12px; padding:12px">
      <div class="row" style="justify-content:space-between; align-items:center; gap:10px">
        <div>
          <strong>Portable bundle</strong>
          <div class="small muted">Exports sessions + baseline + key settings into one JSON file for easy move/backup.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn secondary" id="btnExportBundle" type="button">Export bundle</button>
          <button class="btn secondary" id="btnImportBundle" type="button">Import bundle</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
        <div class="control" style="min-width:220px">
          <label>Import mode</label>
          <select id="bundleMode">
            <option value="replace">Replace current</option>
            <option value="merge">Merge (append sessions)</option>
          </select>
        </div>
        <div class="tog" style="margin-top:22px"><input id="bundleImportSettings" type="checkbox" checked><label for="bundleImportSettings">Also import settings</label></div>
      </div>
      <div class="hint" style="margin-top:8px">Tip: use <span class="mono">Merge</span> when you want to combine multiple days/runs into one review session list.</div>
    </div>
  </div>
</div>
<script>
/* ========== small safety nudge (detect injected network calls via global fetch patch check) ========== */
(function(){
  try{
    // If some extension overwrote fetch in a weird way, it might show as non-native.
    const f = window.fetch;
    const looksNative = f && (String(f).includes('[native code]') || String(f).includes('function fetch'));
    // Not a definitive check; we only display if we already see suspicious error patterns later.
    window.__fetchLooksNative = looksNative;
  }catch(e){}
})();


/* ========== offline guards (no external deps, no network) ========== */
const LOCKDOWN_KEY = 'amp_anomaly_finder_lockdown_v1';
const OFFLINE_GUARD = {
  lockdown: true,
  attempted: [],
  isExternal(u){
    const s = String(u||'');
    return /^https?:\/\//i.test(s) || /^ws(s)?:\/\//i.test(s);
  },
  log(kind, url){
    try{ this.attempted.push({t: Date.now(), kind, url: String(url||'').slice(0, 500)}); }catch(e){}
  }
};
(function loadLockdownPref(){
  try{
    const raw = localStorage.getItem(LOCKDOWN_KEY);
    if(raw === '0') OFFLINE_GUARD.lockdown = false;
  }catch(e){}
})();

(function installOfflineGuards(){
  // fetch
  try{
    if(typeof window.fetch === 'function' && !window.fetch.__offlineWrapped){
      const orig = window.fetch;
      const wrapped = function(input, init){
        const url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
        if(OFFLINE_GUARD.isExternal(url)){
          OFFLINE_GUARD.log('fetch', url);
          if(OFFLINE_GUARD.lockdown) return Promise.reject(new Error('Offline lockdown: blocked fetch to ' + url));
        }
        return orig.apply(this, arguments);
      };
      wrapped.__offlineWrapped = true;
      wrapped.__offlineOrig = orig;
      window.fetch = wrapped;
    }
  }catch(e){}

  // XHR
  try{
    const X = window.XMLHttpRequest;
    if(X && X.prototype && !X.prototype.__offlineWrapped){
      const origOpen = X.prototype.open;
      const origSend = X.prototype.send;
      X.prototype.open = function(method, url){
        try{ this.__offlineUrl = url; }catch(e){}
        return origOpen.apply(this, arguments);
      };
      X.prototype.send = function(body){
        const url = this && this.__offlineUrl;
        if(OFFLINE_GUARD.isExternal(url)){
          OFFLINE_GUARD.log('xhr', url);
          if(OFFLINE_GUARD.lockdown) throw new Error('Offline lockdown: blocked XHR to ' + url);
        }
        return origSend.apply(this, arguments);
      };
      X.prototype.__offlineWrapped = true;
    }
  }catch(e){}

  // WebSocket
  try{
    const WS = window.WebSocket;
    if(typeof WS === 'function' && !WS.__offlineWrapped){
      const WrappedWS = function(url, protocols){
        if(OFFLINE_GUARD.isExternal(url)){
          OFFLINE_GUARD.log('websocket', url);
          if(OFFLINE_GUARD.lockdown) throw new Error('Offline lockdown: blocked WebSocket to ' + url);
        }
        return new WS(url, protocols);
      };
      WrappedWS.__offlineWrapped = true;
      WrappedWS.__offlineOrig = WS;
      WrappedWS.prototype = WS.prototype;
      window.WebSocket = WrappedWS;
    }
  }catch(e){}

  // sendBeacon
  try{
    if(navigator && typeof navigator.sendBeacon === 'function' && !navigator.sendBeacon.__offlineWrapped){
      const orig = navigator.sendBeacon.bind(navigator);
      navigator.sendBeacon = function(url, data){
        if(OFFLINE_GUARD.isExternal(url)){
          OFFLINE_GUARD.log('beacon', url);
          if(OFFLINE_GUARD.lockdown) return false;
        }
        return orig(url, data);
      };
      navigator.sendBeacon.__offlineWrapped = true;
    }
  }catch(e){}
})();

function setLockdown(on){
  OFFLINE_GUARD.lockdown = !!on;
  try{ localStorage.setItem(LOCKDOWN_KEY, OFFLINE_GUARD.lockdown ? '1' : '0'); }catch(e){}
}

function scanForExternalRefs(){
  const out = [];
  const nodes = Array.from(document.querySelectorAll('script[src], link[href], img[src], source[src], video[src], audio[src], iframe[src]'));
  for(const el of nodes){
    const attr = (el.tagName === 'LINK') ? 'href' : 'src';
    const v = el.getAttribute(attr) || '';
    if(/^https?:\/\//i.test(v) || /^ws(s)?:\/\//i.test(v)){
      out.push({tag: el.tagName.toLowerCase(), attr, url: v});
    }
  }
  // also scan inline CSS for url(http...)
  const styles = Array.from(document.querySelectorAll('style'));
  const cssHit = [];
  for(const st of styles){
    const t = st.textContent || '';
    if(/https?:\/\//i.test(t)) cssHit.push('inline <style> contains http(s)');
  }
  return {nodes: out, cssHit};
}

function runOfflineSelfTest(){
  const results = [];
  const ext = scanForExternalRefs();
  results.push({name:'No external src/href', pass: ext.nodes.length===0 && ext.cssHit.length===0, detail: ext});

  // storage
  let storageOk = true;
  try{
    const k = '__ampaf_test__' + Math.random().toString(16).slice(2);
    localStorage.setItem(k, '1');
    localStorage.removeItem(k);
  }catch(e){ storageOk = false; }
  results.push({name:'localStorage available', pass: storageOk});

  // file APIs
  const fileOk = (typeof FileReader === 'function') && (typeof Blob === 'function');
  results.push({name:'File APIs available', pass: !!fileOk});

  // lockdown
  results.push({name:'Offline lockdown enabled', pass: !!OFFLINE_GUARD.lockdown});

  // network attempts
  results.push({name:'No blocked network attempts so far', pass: (OFFLINE_GUARD.attempted.length===0), detail: OFFLINE_GUARD.attempted.slice(-10)});

  return results;
}

function renderSelfTestResults(list){
  const el = els.sysResults;
  if(!el) return;
  const lines = [];
  for(const r of list){
    const icon = r.pass ? '✅' : '❌';
    lines.push(`<div style="margin:6px 0"><strong>${icon} ${escapeHtml(r.name)}</strong>` + (r.pass ? '' : `<div class="small muted" style="margin-top:4px">${escapeHtml(formatSelfTestDetail(r.detail))}</div>`) + `</div>`);
  }
  el.innerHTML = lines.join('');
}

function formatSelfTestDetail(detail){
  if(!detail) return '—';
  try{
    if(Array.isArray(detail)) return detail.map(d=> (d.kind?`${d.kind}: ${d.url}`: String(d))).join(' | ');
    if(detail.nodes){
      const n = detail.nodes || [];
      const css = detail.cssHit || [];
      const a = [];
      if(n.length) a.push('External refs: ' + n.slice(0,6).map(x=>`${x.tag}[${x.attr}]=${x.url}`).join(' ; '));
      if(css.length) a.push(css.join(' ; '));
      return a.join(' | ') || '—';
    }
    return JSON.stringify(detail);
  }catch(e){
    return String(detail);
  }
}

function buildPortableBundle(){
  const pkg = buildJSONPackage();
  const storage = {};
  try{ storage[SETTINGS_KEY] = localStorage.getItem(SETTINGS_KEY); }catch(e){}
  try{ storage[BASE_KEY] = localStorage.getItem(BASE_KEY); }catch(e){}
  return {
    schema: 'amp_anomaly_finder_portable',
    version: 1,
    build: BUILD_TAG,
    exportedAt: new Date().toISOString(),
    lockdown: !!OFFLINE_GUARD.lockdown,
    storage,
    package: pkg
  };
}

function exportPortableBundle(){
  const b = buildPortableBundle();
  const dt = new Date();
  const stamp = dt.toISOString().slice(0,19).replace(/[:T]/g,'-');
  const fn = `AMP_Anomaly_Finder_Portable_${stamp}.json`;
  downloadTextFile(fn, JSON.stringify(b, null, 2), 'application/json');
}

function importPortableBundleText(text, mode, importSettings){
  let b;
  try{ b = JSON.parse(text); }catch(e){ alert('Invalid JSON file.'); return; }
  if(!b || b.schema !== 'amp_anomaly_finder_portable'){
    alert("This JSON doesn't look like an AMP Anomaly Finder portable bundle.");
    return;
  }
  if(b.version !== 1){
    alert('Unsupported portable bundle version: ' + b.version);
    return;
  }

  // optionally restore localStorage keys
  if(importSettings){
    try{
      if(b.storage && typeof b.storage === 'object'){
        if(typeof b.storage[SETTINGS_KEY] === 'string') localStorage.setItem(SETTINGS_KEY, b.storage[SETTINGS_KEY]);
        if(typeof b.storage[BASE_KEY] === 'string') localStorage.setItem(BASE_KEY, b.storage[BASE_KEY]);
      }
    }catch(e){}
  }

  const pkg = b.package;
  if(!pkg || pkg.schema !== 'amp_anomaly_finder_json'){
    alert('Portable bundle is missing the embedded export package.');
    return;
  }

  if(mode === 'merge'){
    // merge sessions: append unique
    const incoming = (pkg.data && Array.isArray(pkg.data.sessions)) ? pkg.data.sessions : [];
    const seen = new Set();
    for(const s of (state.sessions||[])){
      const k = `${(s.filename||s.name||'')}`.toLowerCase() + '|' + String((s.rounds||[]).length);
      seen.add(k);
    }
    for(const s of incoming){
      const k = `${(s.filename||s.name||'')}`.toLowerCase() + '|' + String((s.rounds||[]).length);
      if(seen.has(k)) continue;
      seen.add(k);
      (state.sessions||[]).push(s);
    }
    if(state.sessions.length && state.activeIndex >= state.sessions.length) state.activeIndex = 0;

    // baseline: if none, take incoming
    if(!state.baseline && pkg.data && pkg.data.baseline) state.baseline = pkg.data.baseline;

    // settings: optionally apply incoming settings
    if(importSettings) applyImportedSettings(pkg.settings || null);

    // normalize + render
    for(const sess of (state.sessions||[])){
      if(!sess || !Array.isArray(sess.rounds)) continue;
      if(!sess.name) sess.name = sess.filename || 'Imported session';
      if(typeof recomputeSessionPostFlags === 'function'){
        try{ recomputeSessionPostFlags(sess); }catch(e){}
      }
    }
    if(typeof renderSessionOptions === 'function') renderSessionOptions();
    saveSettings();
    render();
  }else{
    // replace: use existing import pipeline
    if(importSettings){
      // restore settings from storage above, then import JSON (which also applies settings)
      importJSONText(JSON.stringify(pkg));
    }else{
      // import data but keep current settings
      const keep = {
        threshold: state.threshold,
        esLimit: state.esLimit,
        esAutoExclude: state.esAutoExclude,
        hideExcluded: state.hideExcluded,
        onlyAnom: state.onlyAnom,
        onlyActionable: state.onlyActionable,
        query: state.query,
        sort: state.sort,
        baselineMode: state.baselineMode
      };
      importJSONText(JSON.stringify(pkg));
      applyImportedSettings(keep);
      saveSettings();
      render();
    }
  }
}

/* ========== state ========== */
const state = {
  sessions: [],
  activeIndex: 0,
  threshold: 2.5,
  esLimit: 20,
  esAutoExclude: true,
  hideExcluded: false,
  view: 'rounds',
  onlyAnom: false,
  onlyActionable: false,
  onlyFlyers: false,
  preset: "default",
  visibleCols: ["trace", "flyer", "excluded", "why", "cause", "conf", "score", "driver", "peak", "work"],
  advOpen: false,
  query: "",
  sort: "score_desc",
  baselineMode: "none", // none|active|custom
  baseline: null, // {metrics:{key:{med}}, curves:{key:{med}}}
  traceChart: { overlayWork:false, useFiltered:false, showExcluded:true },
  shownRows: [],
  selectedRowIdx: -1,
  selectedTraceIndex: null,
  lastImportReport: null,
  shotLedger: null,
  corr: { points: [], hoverIdx: -1 },
  tcPoints: [],

};

/* ========== settings persistence (Phase 2) ========== */
const SETTINGS_KEY = 'amp_anomaly_finder_settings_v2';
const DEFAULTS = Object.freeze({
  threshold: 2.5,
  esLimit: 20,
  esAutoExclude: true,
  hideExcluded: false,
  onlyAnom: false,
  onlyActionable: false,
  query: '',
  sort: 'score_desc',
  baselineMode: 'none',
  onlyFlyers: false,
  preset: "default",
  visibleCols: ["trace", "flyer", "excluded", "why", "cause", "conf", "score", "driver", "peak", "work"],
  advOpen: false

});

const BUILD_TAG = "v4.0.2 OFFLINE-PORTABLE-REFACTOR";

function applyBuildTag(){
  try{
    document.title = "AMP CSV Anomaly + Diagnostics — " + BUILD_TAG;
    const pill = document.getElementById('buildTagPill');
    if(pill) pill.textContent = BUILD_TAG;
    const about = document.getElementById('buildTagAbout');
    if(about) about.textContent = BUILD_TAG;
  }catch(_e){}
}

function exportPreambleLines(kind){
  const sess = (typeof getActiveSession === 'function') ? getActiveSession() : null;
  const lines = [];
  const now = new Date();
  lines.push(`# amp_anomaly_finder_export=${kind}`);
  lines.push(`# build=${BUILD_TAG}`);
  lines.push(`# exported_at=${now.toISOString()}`);
  lines.push(`# threshold=${Number(state.threshold).toFixed(2)}`);
  lines.push(`# esLimit=${Number(state.esLimit)}`);
  lines.push(`# esAutoExclude=${!!state.esAutoExclude}`);
  lines.push(`# hideExcluded=${!!state.hideExcluded}`);
  lines.push(`# onlyAnom=${!!state.onlyAnom}`);
  lines.push(`# onlyActionable=${!!state.onlyActionable}`);
  lines.push(`# query=${(state.query||"").replace(/\s+/g,' ').trim()}`);
  lines.push(`# sort=${String(state.sort||"custom")}`);
  lines.push(`# baselineMode=${String(state.baselineMode||"none")}`);
  if(sess && sess.name) lines.push(`# activeSession=${String(sess.name)}`);
  return lines;
}

function downloadTextFile(filename, text, mime){
  const blob = new Blob([text], {type: mime || "text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

function buildJSONPackage(){
  // Keep this focused: sessions + baseline + core settings needed to reproduce a view
  const pkg = {
    schema: "amp_anomaly_finder_json",
    version: 1,
    build: BUILD_TAG,
    exportedAt: new Date().toISOString(),
    settings: {
      threshold: state.threshold,
      esLimit: state.esLimit,
      esAutoExclude: state.esAutoExclude,
      hideExcluded: state.hideExcluded,
      onlyAnom: state.onlyAnom,
      onlyActionable: state.onlyActionable,
      query: state.query,
      sort: state.sort,
      baselineMode: state.baselineMode
    },
    data: {
      activeIndex: state.activeIndex,
      baseline: state.baseline || null,
      sessions: state.sessions || []
    }
  };
  return pkg;
}

function exportJSON(){
  const pkg = buildJSONPackage();
  const niceName = (state.sessions && state.sessions.length===1)
    ? (state.sessions[0].name || "session")
    : "amp_sessions";
  const fn = `${niceName}_AMP_Anomaly_Finder.json`.replace(/[^a-zA-Z0-9._-]+/g,'_');
  downloadTextFile(fn, JSON.stringify(pkg, null, 2), "application/json");
}

function applyImportedSettings(s){
  if(!s) return;
  // apply to state first
  if(typeof s.threshold === "number") state.threshold = s.threshold;
  if(typeof s.esLimit === "number") state.esLimit = s.esLimit;
  if(typeof s.esAutoExclude === "boolean") state.esAutoExclude = s.esAutoExclude;
  if(typeof s.hideExcluded === "boolean") state.hideExcluded = s.hideExcluded;
  if(typeof s.onlyAnom === "boolean") state.onlyAnom = s.onlyAnom;
  if(typeof s.onlyActionable === "boolean") state.onlyActionable = s.onlyActionable;
  if(typeof s.query === "string") state.query = s.query;
  if(typeof s.sort === "string") state.sort = s.sort;
  if(typeof s.baselineMode === "string") state.baselineMode = s.baselineMode;

  // sync UI controls (guard if element missing in older builds)
  if(els.th) els.th.value = state.threshold;
  if(els.thVal) els.thVal.textContent = state.threshold.toFixed(2);
  if(els.es) els.es.value = state.esLimit;
  if(els.esVal) els.esVal.textContent = String(state.esLimit);
  if(els.esAuto) els.esAuto.checked = !!state.esAutoExclude;
  if(els.hideEx) els.hideEx.checked = !!state.hideExcluded;
  if(els.onlyAnom) els.onlyAnom.checked = !!state.onlyAnom;
  if(els.onlyActionable) els.onlyActionable.checked = !!state.onlyActionable;
  if(els.q) els.q.value = state.query || "";
  if(els.sortSel) els.sortSel.value = state.sort || "score_desc";
  if(els.baseSel) els.baseSel.value = state.baselineMode || "none";
}

function importJSONText(text){
  let pkg;
  try{
    pkg = JSON.parse(text);
  }catch(e){
    alert("Invalid JSON file.");
    return;
  }
  if(!pkg || pkg.schema !== "amp_anomaly_finder_json"){
    alert("This JSON doesn't look like an AMP Anomaly Finder export.");
    return;
  }
  if(pkg.version !== 1){
    alert("Unsupported JSON export version: " + pkg.version);
    return;
  }

  // data restore
  const data = pkg.data || {};
  if(Array.isArray(data.sessions)){
    state.sessions = data.sessions;
  }else{
    state.sessions = [];
  }
  state.activeIndex = Math.max(0, Math.min((data.activeIndex||0), Math.max(0, state.sessions.length-1)));
  state.baseline = data.baseline || null;

  // settings restore
  applyImportedSettings(pkg.settings || null);

  // post-load safety: normalize derived fields if missing
  // (older exports or hand-edited JSON)
  for(const sess of (state.sessions||[])){
    if(!sess || !Array.isArray(sess.rounds)) continue;
    // ensure name exists
    if(!sess.name) sess.name = sess.filename || "Imported session";
    // recompute tags/exclusions if function exists
    if(typeof recomputeSessionPostFlags === "function"){
      try{ recomputeSessionPostFlags(sess); }catch(e){}
    }
  }

  // refresh UI
  if(typeof renderSessionOptions === "function") renderSessionOptions();
  saveSettings();
  render();
}

function loadSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(!raw) return {...DEFAULTS};
    const parsed = JSON.parse(raw);
    return {...DEFAULTS, ...(parsed||{})};
  }catch(e){
    return {...DEFAULTS};
  }
}

function saveSettings(){
  try{
    const out = {
      threshold: Number(state.threshold),
      esLimit: Number(state.esLimit),
      esAutoExclude: !!state.esAutoExclude,
      hideExcluded: !!state.hideExcluded,
      onlyAnom: !!state.onlyAnom,
      onlyActionable: !!state.onlyActionable,
      query: String(state.query||''),
      sort: String(state.sort||DEFAULTS.sort),
      baselineMode: String(state.baselineMode||DEFAULTS.baselineMode),
      onlyFlyers: !!state.onlyFlyers,
      preset: String(state.preset||DEFAULTS.preset),
      visibleCols: Array.isArray(state.visibleCols)? state.visibleCols : DEFAULTS.visibleCols,
      advOpen: !!state.advOpen
    };
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(out));
  }catch(e){}
}

function applySettingsToStateAndUI(s){
  // State
  state.threshold = Number.isFinite(Number(s.threshold)) ? Number(s.threshold) : DEFAULTS.threshold;
  state.esLimit = Number.isFinite(Number(s.esLimit)) ? Number(s.esLimit) : DEFAULTS.esLimit;
  state.esAutoExclude = ('esAutoExclude' in s) ? !!s.esAutoExclude : DEFAULTS.esAutoExclude;
  state.hideExcluded = ('hideExcluded' in s) ? !!s.hideExcluded : DEFAULTS.hideExcluded;
  state.onlyAnom = ('onlyAnom' in s) ? !!s.onlyAnom : DEFAULTS.onlyAnom;
  state.onlyActionable = ('onlyActionable' in s) ? !!s.onlyActionable : DEFAULTS.onlyActionable;
  state.onlyFlyers = ('onlyFlyers' in s) ? !!s.onlyFlyers : DEFAULTS.onlyFlyers;
  state.preset = (typeof s.preset === 'string') ? s.preset : DEFAULTS.preset;
  state.visibleCols = Array.isArray(s.visibleCols) ? s.visibleCols.slice() : (DEFAULTS.visibleCols||[]).slice();
  state.advOpen = ('advOpen' in s) ? !!s.advOpen : DEFAULTS.advOpen;
  state.query = (typeof s.query === 'string') ? s.query : DEFAULTS.query;
  state.sort = (typeof s.sort === 'string') ? s.sort : DEFAULTS.sort;
  state.baselineMode = (typeof s.baselineMode === 'string') ? s.baselineMode : DEFAULTS.baselineMode;

  // UI controls
  if(els.th){ els.th.value = String(state.threshold); els.thVal.textContent = state.threshold.toFixed(2); }
  if(els.es){ els.es.value = String(state.esLimit); els.esVal.textContent = String(state.esLimit); }
  if(els.esAuto){ els.esAuto.checked = !!state.esAutoExclude; }
  if(els.hideEx){ els.hideEx.checked = !!state.hideExcluded; }
  if(els.onlyAnom){ els.onlyAnom.checked = !!state.onlyAnom; }
  if(els.onlyActionable){ els.onlyActionable.checked = !!state.onlyActionable; }
  if(els.q){ els.q.value = state.query || ''; }

  // Sort: reset header sort unless custom is explicitly in play
  if(els.sortSel){
    if(state.sort === 'custom'){
      els.sortSel.value = 'custom';
    }else{
      els.sortSel.value = state.sort || DEFAULTS.sort;
      state.sortField = null;
      state.sortDir = null;
      document.querySelectorAll('th').forEach(x=>x.classList.remove('sortedAsc','sortedDesc'));
    }
  }

  if(els.baseSel){
    // allow only valid values
    const v = (state.baselineMode || 'none');
    els.baseSel.value = (['none','active','custom'].includes(v) ? v : 'none');
  }
  if(els.presetSel){
    const v = (state.preset || DEFAULTS.preset || 'default');
    els.presetSel.value = (['default','strict','sensitive'].includes(v) ? v : 'default');
  }
  if(els.advDetails){
    els.advDetails.open = !!state.advOpen;
  }
  syncQuickChips();
  applyColumnVisibility();
  syncColumnModalChecks();

}

function resetDefaults(){
  applySettingsToStateAndUI({...DEFAULTS});
  // do NOT clear saved baseline (that has its own buttons)
  saveSettings();
}

/* ========== UX helpers ========== */
const COL_ALL = ["trace","flyer","excluded","tag","why","cause","conf","score","driver","peak","work"];
const COL_ESSENTIALS = ["trace", "flyer", "excluded", "why", "cause", "conf", "score", "driver", "peak", "work"];

function setChip(btn, on){
  if(!btn) return;
  btn.classList.toggle('on', !!on);
  btn.classList.toggle('off', !on);
}

function syncQuickChips(){
  setChip(els.chipActionable, !!state.onlyActionable);
  setChip(els.chipAnom, !!state.onlyAnom);
  setChip(els.chipFlyers, !!state.onlyFlyers);
  setChip(els.chipHideEx, !!state.hideExcluded);
}

function applyPreset(preset){
  const p = (preset || 'default');
  state.preset = p;
  if(p === 'strict'){
    state.threshold = 3.2;
    state.onlyAnom = true;
    state.onlyActionable = true;
    state.onlyFlyers = false;
    state.hideExcluded = true;
  } else if(p === 'sensitive'){
    state.threshold = 2.0;
    state.onlyAnom = true;
    state.onlyActionable = false;
    state.onlyFlyers = false;
    state.hideExcluded = false;
  } else {
    // default
    state.threshold = DEFAULTS.threshold;
    state.onlyAnom = DEFAULTS.onlyAnom;
    state.onlyActionable = DEFAULTS.onlyActionable;
    state.onlyFlyers = DEFAULTS.onlyFlyers;
    state.hideExcluded = DEFAULTS.hideExcluded;
  }
  // keep ES/baseline as-is (users may tune these)
  applySettingsToStateAndUI(state); // sync UI
  saveSettings();
  render();
}

function applyColumnVisibility(){
  const vis = Array.isArray(state.visibleCols) ? state.visibleCols : (DEFAULTS.visibleCols||[]);
  const hide = COL_ALL.filter(k=>!vis.includes(k));
  const css = hide.map(k=>`th[data-col="${k}"], td[data-col="${k}"]{display:none !important;}`).join("\n");
  try{
    const st = els.colHideStyle || document.getElementById('colHideStyle');
    if(st) st.textContent = css;
  }catch(e){}
}

function syncColumnModalChecks(){
  if(!els.colModal) return;
  const vis = Array.isArray(state.visibleCols) ? state.visibleCols : (DEFAULTS.visibleCols||[]);
  els.colModal.querySelectorAll('input[type="checkbox"][data-col]').forEach(cb=>{
    const k = cb.getAttribute('data-col');
    cb.checked = vis.includes(k);
  });
}

function openColModal(){
  if(!els.colModal) return;
  syncColumnModalChecks();
  els.colModal.classList.add('show');
}
function closeColModal(){
  if(!els.colModal) return;
  els.colModal.classList.remove('show');
}

const els = {
  fileIn: document.getElementById('fileIn'),
  wizard: document.getElementById('wizard'),
  drop: document.getElementById('drop'),
  sessionSel: document.getElementById('sessionSel'),
  th: document.getElementById('th'),
  thVal: document.getElementById('thVal'),
  es: document.getElementById('es'),
  esVal: document.getElementById('esVal'),
  esAuto: document.getElementById('esAuto'),
  hideEx: document.getElementById('hideEx'),
  onlyAnom: document.getElementById('onlyAnom'),
  onlyActionable: document.getElementById('onlyActionable'),
  q: document.getElementById('q'),
  sortSel: document.getElementById('sortSel'),

  presetSel: document.getElementById('presetSel'),
  advDetails: document.getElementById('advDetails'),
  chipActionable: document.getElementById('chipActionable'),
  chipAnom: document.getElementById('chipAnom'),
  chipFlyers: document.getElementById('chipFlyers'),
  chipHideEx: document.getElementById('chipHideEx'),
  colChipBtn: document.getElementById('colChipBtn'),
  colModal: document.getElementById('colModal'),
  colCloseBtn: document.getElementById('colCloseBtn'),
  colShowEssentials: document.getElementById('colShowEssentials'),
  colShowAll: document.getElementById('colShowAll'),
colHideStyle: document.getElementById('colHideStyle'),
  insAdvice: document.getElementById('insAdvice'),
  baseSel: document.getElementById('baseSel'),
  btnSaveBase: document.getElementById('btnSaveBase'),
  btnClrBase: document.getElementById('btnClrBase'),
  btnExport: document.getElementById('btnExport'),
  btnMore: document.getElementById('btnMore'),
  moreMenu: document.getElementById('moreMenu'),
  miExportJSON: document.getElementById('miExportJSON'),
  miImportJSON: document.getElementById('miImportJSON'),
  miCopy: document.getElementById('miCopy'),
  miClearSort: document.getElementById('miClearSort'),
  miReset: document.getElementById('miReset'),
  miClear: document.getElementById('miClear'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnImportJSON: document.getElementById('btnImportJSON'),
  jsonIn: document.getElementById('jsonIn'),
  btnCopy: document.getElementById('btnCopy'),
  btnClearSort: document.getElementById('btnClearSort'),
  btnReset: document.getElementById('btnReset'),
  btnClear: document.getElementById('btnClear'),
  empty: document.getElementById('empty'),
  tableWrap: document.getElementById('tableWrap'),
  tbody: document.getElementById('tbody'),
  kN: document.getElementById('kN'),
  kA: document.getElementById('kA'),
  kF: document.getElementById('kF'),
sessLabel: document.getElementById('sessLabel'),
  sessMeta: document.getElementById('sessMeta'),
  tabRounds: document.getElementById('tabRounds'),
  tabSessions: document.getElementById('tabSessions'),
  sessionsWrap: document.getElementById('sessionsWrap'),
sessionsTbody: document.getElementById('sessionsTbody'),
  btnExportSessions: document.getElementById('btnExportSessions'),
  sessChart: document.getElementById('sessChart'),
  traceChart: document.getElementById('traceChart'),
  tcOverlayWork: document.getElementById('tcOverlayWork'),
  tcUseFiltered: document.getElementById('tcUseFiltered'),
  tcShowExcluded: document.getElementById('tcShowExcluded'),
baseChip: document.getElementById('baseChip'),
  showChip: document.getElementById('showChip'),
  filterChip: document.getElementById('filterChip'),
tabCorr: document.getElementById('tabCorr'),
  corrWrap: document.getElementById('corrWrap'),
  corrFile: document.getElementById('corrFile'),
  corrJoin: document.getElementById('corrJoin'),
  btnCorrClear: document.getElementById('btnCorrClear'),
  corrChart: document.getElementById('corrChart'),
  corrTbody: document.getElementById('corrTbody'),
  corrStatus: document.getElementById('corrStatus'),
  corrStats: document.getElementById('corrStats'),

  detectSummary: document.getElementById('detectSummary'),
  detectSummaryTitle: document.getElementById('detectSummaryTitle'),
  detectSummaryBody: document.getElementById('detectSummaryBody'),
  btnClearDetect: document.getElementById('btnClearDetect'),

  inspectorWrap: document.getElementById('inspectorWrap'),
  insTitle: document.getElementById('insTitle'),
  insBucket: document.getElementById('insBucket'),
  insScore: document.getElementById('insScore'),
  insDriver: document.getElementById('insDriver'),
  insCause: document.getElementById('insCause'),
  insWhy: document.getElementById('insWhy'),
  insVals: document.getElementById('insVals'),
  insZ: document.getElementById('insZ'),
  insUserExcluded: document.getElementById('insUserExcluded'),
  insExcludedWhy: document.getElementById('insExcludedWhy'),
  insTag: document.getElementById('insTag'),
  insTags: document.getElementById('insTags'),
  btnInsTagSave: document.getElementById('btnInsTagSave'),
  btnInsTagClear: document.getElementById('btnInsTagClear'),
  btnInsPrev: document.getElementById('btnInsPrev'),
  btnInsNext: document.getElementById('btnInsNext'),
  btnInsClear: document.getElementById('btnInsClear'),

};

/* ========== utils ========== */
function toNum(x){
  if(x==null) return null;
  const s = String(x).trim().replace(/,/g,''); // tolerate thousands separators
  if(s==="") return null;
  const v = Number(s);
  return Number.isFinite(v) ? v : null;
}
function fmt(v, d=3){
  if(!Number.isFinite(v)) return "—";
  return Number(v).toFixed(d);
}

function strengthTier(az){
  az = Math.abs(Number(az)||0);
  if(az>=2.8) return 3;
  if(az>=2.2) return 2;
  if(az>=1.6) return 1;
  return 0;
}
function strengthGlyph(t){
  const n = Number(t)||0;
  return n<=0 ? "—" : "•".repeat(Math.min(3, Math.max(1,n)));
}
function median(arr){
  const a = arr.filter(v=>Number.isFinite(v)).slice().sort((x,y)=>x-y);
  const n = a.length;
  if(!n) return null;
  const mid = Math.floor(n/2);
  return n%2 ? a[mid] : (a[mid-1]+a[mid])/2;
}
function mad(arr, med){
  const dev = arr.filter(v=>Number.isFinite(v)).map(v=>Math.abs(v-med));
  return median(dev);
}
function mean(arr){
  const a = arr.filter(v=>Number.isFinite(v));
  if(!a.length) return null;
  return a.reduce((s,v)=>s+v,0)/a.length;
}
function stdev(arr){
  const mu = mean(arr);
  if(mu==null) return null;
  const a = arr.filter(v=>Number.isFinite(v));
  if(a.length<2) return null;
  const v = a.reduce((s,x)=>s+(x-mu)**2,0)/(a.length-1);
  return Math.sqrt(v);
}
function robustZ(x, st){
  // st: {med, mad, sd, mu}
  if(!Number.isFinite(x) || st.med==null) return 0;
  if(st.mad && st.mad>0) return 0.6745*(x-st.med)/st.mad;
  if(st.sd && st.sd>0 && st.mu!=null) return (x-st.mu)/st.sd;
  return 0;
}
function clsFromScore(score){
  if(score>=3.5) return "flyer";
  if(score>=2.5) return "high";
  if(score>=1.5) return "moderate";
  return "normal";
}
function escapeHtml(s){
  return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function pickDot(bucket){
  if(bucket==="flyer") return "bad";
  if(bucket==="high") return "warn";
  if(bucket==="moderate") return "mid";
  return "good";
}

/* ========== CSV parser (handles quotes) ========== */
function parseCSV(text){
  // sniff delimiter (comma vs semicolon)
  const firstLine = (text.split(/\r?\n/).find(l=>l.trim().length) || "");
  const comma = (firstLine.match(/,/g)||[]).length;
  const semi  = (firstLine.match(/;/g)||[]).length;
  const delim = semi>comma ? ';' : ',';

  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        const next = text[i+1];
        if(next === '"'){ cur+='"'; i++; }
        else inQ = false;
      } else cur += ch;
    } else {
      if(ch === '"') inQ = true;
      else if(ch === delim){
        row.push(cur); cur="";
      } else if(ch === '\n'){
        row.push(cur); rows.push(row);
        row=[]; cur="";
      } else if(ch === '\r'){
        // ignore
      } else cur += ch;
    }
  }
  row.push(cur); rows.push(row);
  // trim trailing empty rows
  while(rows.length && rows[rows.length-1].every(c=>String(c??"").trim()==="")) rows.pop();
  return rows;
}
function isRowEmpty(r){ return !r || r.every(c=>String(c??"").trim()===""); }
function splitBlocks(rows){
  const blocks = [];
  let cur = [];
  for(const r of rows){
    if(isRowEmpty(r)){
      if(cur.length){ blocks.push(cur); cur=[]; }
    } else cur.push(r);
  }
  if(cur.length) blocks.push(cur);
  return blocks;
}

/* ========== AMP reshape ========== */
function detectTraceHeader(header){
  // Returns indices of trace columns and their names.
  const cols = [];
  for(let i=0;i<header.length;i++){
    const h = String(header[i]??"").trim();
    if(/^(trace\s*\d+|trace\d+)$/i.test(h) || /^Trace\s*\d+/i.test(h)){
      cols.push({i, name:h});
    }
  }
  // If none, try all columns after first as traces if "Trace" appears anywhere
  if(!cols.length){
    const anyTrace = header.some(h=>/trace/i.test(String(h||"")));
    if(anyTrace && header.length>=3){
      for(let i=1;i<header.length;i++){
        cols.push({i, name:String(header[i]??`Trace ${i}`).trim() || `Trace ${i}`});
      }
    }
  }
  return cols;
}

function parseMetricBlock(block){
  // wide: first row header: ["", "Trace 1", ...]
  const header = block[0].map(x => String(x??"").trim());
  const traces = header.slice(1).map((h,i)=>h||`Trace ${i+1}`);
  const n = traces.length;
  if(n<1) return null;

  // map varName -> array (len n)
  const map = new Map();
  for(let r=1;r<block.length;r++){
    const varName = String(block[r][0]??"").trim();
    if(!varName) continue;
    const vals = [];
    for(let c=1;c<1+n;c++){
      vals.push(block[r][c] ?? "");
    }
    map.set(varName, vals);
  }
  function getVar(keys){
    for(const k of keys){
      for(const [name, vals] of map.entries()){
        if(name.toLowerCase() === k.toLowerCase()) return {name, vals};
      }
    }
    for(const k of keys){
      for(const [name, vals] of map.entries()){
        if(name.toLowerCase().includes(k.toLowerCase())) return {name, vals};
      }
    }
    return null;
  }

  const flyerRow = getVar(["Flyer"]);
  const peakRow  = getVar(["Peak Force"]);
  const workRow  = getVar(["Work Done"]);
  const startRow = getVar(["Starting Pos","Starting Position"]);
  const termRow  = getVar(["Terminal Force"]);

  if(!peakRow && !workRow && !startRow && !termRow) return null;

  const rounds = [];
  for(let i=0;i<n;i++){
    const traceName = traces[i] || `Trace ${i+1}`;
    const flyer = flyerRow ? String(flyerRow.vals[i]??"").trim().toLowerCase()==="true" : false;
    rounds.push({
      traceIndex: i+1,
      trace: traceName,
      flyerRaw: flyer,
      flyer: flyer,
      peakForce: peakRow ? toNum(peakRow.vals[i]) : null,
      workDone: workRow ? toNum(workRow.vals[i]) : null,
      startingPos: startRow ? toNum(startRow.vals[i]) : null,
      terminalForce: termRow ? toNum(termRow.vals[i]) : null,
      curve: null, // {x:[], y:[]}
      // curve features
      earlySpike: null,
      roughness: null,
      endFlat: null,
      endDrop: null,
      midSlope: null,
      // scoring
      z: {},
      score: 0,
      bucket: "normal",
      driver: "—",
      diags: [],
      cause: "—",
      conf: 0
    });
  }
  return {rounds, map, n};
}

function parseCurveBlock(block){
  // Expect header row with first col like Position/Depth and trace columns after
  const header = block[0].map(x => String(x??"").trim());
  const traceCols = detectTraceHeader(header);
  if(!traceCols.length) return null;

  // find x column: prefer first col if it contains 'pos'/'depth' or has numeric rows
  let xIdx = 0;
  for(let i=0;i<header.length;i++){
    const h = header[i].toLowerCase();
    if(h.includes('pos') || h.includes('depth') || h.includes('mm') || h.includes('in')) { xIdx=i; break; }
  }

  const xs = [];
  const ysByTrace = traceCols.map(()=>[]);
  for(let r=1;r<block.length;r++){
    const x = toNum(block[r][xIdx]);
    if(!Number.isFinite(x)) continue;
    xs.push(x);
    traceCols.forEach((tc,ti)=>{
      ysByTrace[ti].push(toNum(block[r][tc.i]));
    });
  }
  if(xs.length < 10) return null;

  return {
    traces: traceCols.map(tc=>tc.name),
    x: xs,
    ysByTrace
  };
}

function computeCurveFeatures(round){
  const c = round.curve;
  if(!c || !c.y || c.y.length<10) return;
  const y = c.y.filter(v=>Number.isFinite(v));
  if(y.length<10) return;

  const n = y.length;
  const yMin = Math.min(...y), yMax = Math.max(...y);
  const range = (yMax - yMin) || 1e-9;

  const kEarly = Math.max(5, Math.floor(n*0.12));
  const kEnd   = Math.max(5, Math.floor(n*0.12));
  const early = y.slice(0, kEarly);
  const end   = y.slice(n-kEnd);

  const earlyMax = Math.max(...early);
  const overallMax = yMax;
  round.earlySpike = (overallMax>0) ? (earlyMax / overallMax) : null; // ratio

  // roughness: mean abs 2nd diff normalized by range
  let s2 = 0, cnt = 0;
  for(let i=1;i<n-1;i++){
    const d2 = (y[i+1]-2*y[i]+y[i-1]);
    s2 += Math.abs(d2);
    cnt++;
  }
  round.roughness = cnt ? (s2/cnt)/range : null;

  // endFlat: end segment amplitude small
  const endMin = Math.min(...end), endMax = Math.max(...end);
  const endAmp = (endMax-endMin)/range;
  round.endFlat = endAmp; // smaller is flatter (we will invert for z)

  // endDrop: slope of last segment (linear fit) normalized by range
  // using index as x if real x missing
  let sumX=0,sumY=0,sumXY=0,sumXX=0;
  for(let i=0;i<end.length;i++){
    const xx=i, yy=end[i];
    sumX += xx; sumY += yy; sumXY += xx*yy; sumXX += xx*xx;
  }
  const denom = (kEnd*sumXX - sumX*sumX) || 1e-9;
  const slope = (kEnd*sumXY - sumX*sumY)/denom; // units per index
  round.endDrop = slope / range; // negative means dropping

  // midSlope: slope from 10% to 60%
  const a0 = Math.floor(n*0.10);
  const a1 = Math.floor(n*0.60);
  const mid = y.slice(a0, Math.max(a0+5,a1));
  let sx=0, sy=0, sxy=0, sxx=0;
  for(let i=0;i<mid.length;i++){
    const xx=i, yy=mid[i];
    sx+=xx; sy+=yy; sxy+=xx*yy; sxx+=xx*xx;
  }
  const den = (mid.length*sxx - sx*sx) || 1e-9;
  const ms = (mid.length*sxy - sx*sy)/den;
  round.midSlope = ms / range; // higher => steeper
}

function buildSession(rows, filename){
  const blocks = splitBlocks(rows);
  let metric = null;
  let curve = null;

  // choose best metric block: contains Peak Force row
  for(const b of blocks){
    const m = parseMetricBlock(b);
    if(m){ metric = m; break; }
  }
  if(!metric) throw new Error("Couldn't find AMP metric rows (Peak Force/Work Done/etc).");

  // choose best curve block: numeric x + trace columns
  for(const b of blocks){
    const c = parseCurveBlock(b);
    if(c){
      // sanity: number of traces should match metric count OR at least >1
      curve = c; break;
    }
  }

  // attach curves if sizes match (by index)
  if(curve){
    // If curve traces count doesn't match, we still map by order up to min
    const mN = metric.rounds.length;
    const cN = curve.ysByTrace.length;
    const n = Math.min(mN, cN);
    for(let i=0;i<n;i++){
      metric.rounds[i].curve = {x: curve.x, y: curve.ysByTrace[i]};
      computeCurveFeatures(metric.rounds[i]);
    }
  }

  // compute stats + scores
  const rounds = metric.rounds;

  // scalar metrics
  const scalarMetrics = [
    {key:"peakForce", label:"Peak Force", w:1.00},
    {key:"workDone", label:"Work Done", w:0.85},
    {key:"startingPos", label:"Starting Pos", w:0.70},
    {key:"terminalForce", label:"Terminal Force", w:0.70}
  ];

  // curve metrics (if present)
  const curveMetrics = [
    // earlySpike higher means more spike
    {key:"earlySpike", label:"Early Spike", w:0.65, present: r=>Number.isFinite(r.earlySpike)},
    // roughness higher means more jagged
    {key:"roughness", label:"Jagged", w:0.75, present: r=>Number.isFinite(r.roughness)},
    // endFlat smaller means flatter: use inv
    {key:"endFlat", label:"End Flat", w:0.55, present: r=>Number.isFinite(r.endFlat), invert:true},
    // endDrop negative means drop: use negative to highlight drops
    {key:"endDrop", label:"End Drop", w:0.55, present: r=>Number.isFinite(r.endDrop), signed:true, negativeIsBad:true},
    {key:"midSlope", label:"Mid Slope", w:0.35, present: r=>Number.isFinite(r.midSlope)}
  ];

  // build stats
  const stats = {};
  function makeStats(key){
    const arr = rounds.map(r=>r[key]).filter(v=>Number.isFinite(v));
    const med = median(arr);
    let theMad = (med==null) ? null : mad(arr, med);
    let sd=null, mu=null;
    if(!theMad || theMad===0){
      sd = stdev(arr);
      mu = mean(arr);
    }
    return {med, mad: theMad, sd, mu};
  }

  for(const m of scalarMetrics){
    stats[m.key] = {...makeStats(m.key), label:m.label};
  }
  const hasCurves = rounds.some(r=>r.curve && r.curve.y && r.curve.y.length>=10);
  if(hasCurves){
    for(const m of curveMetrics){
      // include only if at least some values exist
      const exists = rounds.some(r=>m.present(r));
      if(!exists) continue;
      stats[m.key] = {...makeStats(m.key), label:m.label, invert: !!m.invert, signed: !!m.signed, negativeIsBad: !!m.negativeIsBad};
    }
  }

  // baseline stats (optional)
  const base = getBaselineForScoring();

  // score each round
  for(const r of rounds){
    let scoreSum=0, wSum=0;
    let driverAbs=-1, driver="—";

    // scalar z
    for(const m of scalarMetrics){
      const st = stats[m.key];
      const z = robustZ(r[m.key], st);
      r.z[m.key]=z;
      const az = Math.abs(z);
      scoreSum += m.w*az; wSum += m.w;
      if(az>driverAbs){ driverAbs=az; driver=`${m.label} (${az.toFixed(2)}σ)`; }
    }

    // curve z (with special handling)
    if(hasCurves){
      for(const m of curveMetrics){
        const st = stats[m.key];
        if(!st) continue;
        if(!m.present(r)) { r.z[m.key]=0; continue; }

        let val = r[m.key];
        // invert endFlat so "flatter" = bigger badness
        if(m.invert) val = -val;
        // for signed negative-is-bad, emphasize negative direction
        let z = robustZ(val, {...st, med: st.med!=null ? (m.invert? -st.med : st.med) : st.med});
        if(m.negativeIsBad){
          // treat positive slopes as OK, negative as bad; clamp to <=0 then take abs
          z = Math.min(0, z);
        }
        r.z[m.key]=z;
        const az = Math.abs(z);
        scoreSum += m.w*az; wSum += m.w;
        if(az>driverAbs){
          driverAbs=az;
          driver=`${m.label} (${az.toFixed(2)}σ)`;
        }
      }
    }

    // baseline comparison bump (session-wide drift)
    let baseBump = 0;
    if(base){
      // Compare key medians: peakForce, workDone, midSlope (if available)
      // If current session median is far from baseline, add small bump so it appears in summary/driver.
      const curPF = stats.peakForce.med, basePF = base.metrics?.peakForce?.med;
      if(Number.isFinite(curPF) && Number.isFinite(basePF) && basePF!==0){
        const rel = Math.abs(curPF-basePF)/Math.abs(basePF);
        if(rel>0.12) baseBump += Math.min(0.6, rel*2.0); // cap
      }
      const curWD = stats.workDone.med, baseWD = base.metrics?.workDone?.med;
      if(Number.isFinite(curWD) && Number.isFinite(baseWD) && baseWD!==0){
        const rel = Math.abs(curWD-baseWD)/Math.abs(baseWD);
        if(rel>0.12) baseBump += Math.min(0.5, rel*1.6);
      }
      const curMS = stats.midSlope?.med, baseMS = base.curves?.midSlope?.med;
      if(Number.isFinite(curMS) && Number.isFinite(baseMS) && baseMS!==0){
        const rel = Math.abs(curMS-baseMS)/Math.abs(baseMS);
        if(rel>0.15) baseBump += Math.min(0.4, rel*1.2);
      }
      if(baseBump>0 && driverAbs<1.2){
        driver = `Baseline drift (+${baseBump.toFixed(2)})`;
      }
    }

    let score = wSum>0 ? (scoreSum/wSum) : 0;
    score += baseBump;

    // flyer determination: existing Flyer row OR any metric abs(z) >= 3.5
    let computedFlyer = false;
    for(const k in r.z){
      if(Math.abs(r.z[k]) >= 3.5) { computedFlyer = true; break; }
    }
    r.flyer = r.flyerRaw || computedFlyer;
    if(r.flyer) score = Math.max(score, 3.0) + 0.55;

    r.score = score;
    r.driver = driver;
    r.bucket = clsFromScore(score);

    // diagnostics + cause labels
    assignDiagnosticsAndCause(r, hasCurves);
  }

  // session summary
  const anomCnt = rounds.filter(r=>r.score >= state.threshold).length;
  const peakArr = rounds.map(r=>r.peakForce).filter(v=>Number.isFinite(v));
  const peakMed = median(peakArr);
  const curveYes = hasCurves ? "yes" : "no";

  return {
    name: filename,
    rounds,
    stats,
    hasCurves,
    summary: { 
      n: rounds.length, 
      anomalies: anomCnt, 
      flyers: rounds.filter(r=>r.flyer).length,
      peakMed, 
      peakES: (peakArr.length ? (Math.max(...peakArr)-Math.min(...peakArr)) : null),
      workMed: median(rounds.map(r=>r.workDone).filter(v=>Number.isFinite(v))),
      roughMed: median(rounds.map(r=>r.roughness).filter(v=>Number.isFinite(v))),
      curveYes 
    }
  };
}

function assignDiagnosticsAndCause(r, hasCurves){
  const diags = [];

  // scalar triggers
  const azPeak = Math.abs(r.z.peakForce||0);
  const azWork = Math.abs(r.z.workDone||0);
  const azTerm = Math.abs(r.z.terminalForce||0);

  // curve triggers (z values computed)
  const azEarly = Math.abs(r.z.earlySpike||0);
  const azRough = Math.abs(r.z.roughness||0);
  const azFlat  = Math.abs(r.z.endFlat||0);
  const azDrop  = Math.abs(r.z.endDrop||0);

  const t = state.threshold;

  // severity tiers for Diagnostics (for UI glyphs)
  if(hasCurves){
    r.diagStrength = {
      earlySpike: strengthTier(azEarly),
      jagged: strengthTier(azRough),
      endFlat: strengthTier(azFlat),
      endDrop: strengthTier(azDrop)
    };
  } else {
    r.diagStrength = null;
  }

  // add diag tags based on notable drivers (use fixed smaller thresholds for flags)
  if(azPeak>=2.2 || azWork>=2.2 || azTerm>=2.2) diags.push("Force outlier");
  if(hasCurves){
    if(azEarly>=2.0) diags.push("Early spike");
    if(azRough>=2.0) diags.push("Jagged");
    if(azFlat>=2.0) diags.push("End flat");
    if(azDrop>=2.0) diags.push("End drop");
  }
  if(r.flyer) diags.unshift("Flyer");

  r.diags = diags.length ? diags : ["—"];

  // probable cause mapping (pick top feature)
  const candidates = [];
  // (scoreContribution, label, confidenceHint)
  if(hasCurves && azEarly>=1.6) candidates.push([azEarly, "Case mouth / chamfer / donut", 0.70]);
  if(hasCurves && azRough>=1.6) candidates.push([azRough, "Carbon / neck-wall inconsistency / damage", 0.68]);
  if(azPeak>=1.8 || azWork>=1.8) candidates.push([Math.max(azPeak,azWork), "Neck tension / sizing / anneal variance", 0.64]);
  if(hasCurves && (azFlat>=1.8 || azDrop>=1.8)) candidates.push([Math.max(azFlat, azDrop), "Bearing surface / seating setup inconsistency", 0.55]);

  // baseline drift could be session-wide; for per-round we keep cause from z.
  // Build explainability: top contributing standardized signals (z-scores)
  const contrib = [];
  // force/scalars
  contrib.push(["Peak Force", r.z.peakForce||0]);
  contrib.push(["Work Done", r.z.workDone||0]);
  contrib.push(["Terminal Force", r.z.terminalForce||0]);
  if(hasCurves){
    contrib.push(["Early spike", r.z.earlySpike||0]);
    contrib.push(["Jaggedness", r.z.roughness||0]);
    contrib.push(["End flat", r.z.endFlat||0]);
    contrib.push(["End drop", r.z.endDrop||0]);
  } else {
    r.noCurveData = true;
  }
  const contribTop = contrib
    .map(([lab,z])=>({lab, z:Number(z)||0, az:Math.abs(Number(z)||0)}))
    .filter(o=>o.az>=1.0)
    .sort((a,b)=>b.az-a.az)
    .slice(0,3);

  candidates.sort((a,b)=>b[0]-a[0]);

  if(!candidates.length){
    r.cause = "—";
    r.conf = 0;
    return;
  }

  const [topZ, cause, baseConf] = candidates[0];
  // confidence: scale with severity, capped
  let conf = Math.min(0.95, baseConf + Math.max(0, (topZ-2.0))*0.08);
  if(r.flyer) conf = Math.min(0.98, conf + 0.08);
  r.cause = cause;
  r.conf = conf;

  // Human-readable one-liner for tooltips
  if(typeof contribTop !== "undefined" && contribTop && contribTop.length){
    r.causeExplain = contribTop.map(o=>`${o.lab} ${o.z>=0?'+':''}${o.z.toFixed(2)}σ`).join(' • ');
  } else if(r.noCurveData){
    r.causeExplain = "No curve columns in this export (force-only signals).";
  } else {
    r.causeExplain = "—";
  }
}

/* ========== baseline storage ========== */
const BASE_KEY = "amp_diag_baseline_v1";
function loadBaseline(){
  try{
    const s = localStorage.getItem(BASE_KEY);
    if(!s) return null;
    return JSON.parse(s);
  }catch(e){ return null; }
}
function saveBaseline(obj){
  try{ localStorage.setItem(BASE_KEY, JSON.stringify(obj)); }catch(e){}
}
function clearBaseline(){
  try{ localStorage.removeItem(BASE_KEY); }catch(e){}
}
function getBaselineForScoring(){
  if(state.baselineMode==="none") return null;
  if(state.baselineMode==="active"){
    const sess = state.sessions[state.activeIndex];
    if(!sess) return null;
    return sessionToBaseline(sess);
  }
  if(state.baselineMode==="custom"){
    return state.baseline || null;
  }
  return null;
}
function sessionToBaseline(sess){
  const b = {metrics:{}, curves:{}};
  // store medians
  for(const k of ["peakForce","workDone","startingPos","terminalForce"]){
    const st = sess.stats?.[k];
    if(st && st.med!=null) b.metrics[k]={med:st.med};
  }
  for(const k of ["earlySpike","roughness","endFlat","endDrop","midSlope"]){
    const st = sess.stats?.[k];
    if(st && st.med!=null) b.curves[k]={med:st.med};
  }
  return b;
}

/* ========== rendering ========== */

function recomputeSessionPostFlags(sess){
  // tags: top5/bottom5 by Peak Force; ES-based exclusion of extremes
  if(!sess || !sess.rounds) return sess;
  const rounds = sess.rounds;
  // clear prior tags/exclusions that are derived
  for(const r of rounds){
    r.tag = "";
    r.excluded = false;
    r.flags = (r.flags && Array.isArray(r.flags)) ? r.flags.filter(f=>!f.startsWith("ES ") && f!=="Top5" && f!=="Bottom5") : [];
    // keep diag list but remove ES breach / tags (we'll re-add)
    if(r.diags && Array.isArray(r.diags)){
      r.diags = r.diags.filter(d=>d!=="ES breach" && d!=="Top5" && d!=="Bottom5");
    }
  }

  const peakPairs = rounds
    .map((r,i)=>({i, v:r.peakForce}))
    .filter(o=>Number.isFinite(o.v))
    .sort((a,b)=>b.v-a.v);

  // Tag top/bottom 5 (or fewer if small session)
  const k = Math.min(5, peakPairs.length);
  for(let j=0;j<k;j++){
    const topIdx = peakPairs[j].i;
    const botIdx = peakPairs[peakPairs.length-1-j].i;
    const rt = rounds[topIdx];
    const rb = rounds[botIdx];
    if(rt){
      rt.tag = rt.tag ? (rt.tag+";Top5") : "Top5";
      rt.flags = rt.flags || [];
      rt.flags.push("Top5");
    }
    if(rb){
      rb.tag = rb.tag ? (rb.tag+";Bottom5") : "Bottom5";
      rb.flags = rb.flags || [];
      rb.flags.push("Bottom5");
    }
  }

  // Session ES (Peak Force)
  const peaks = peakPairs.map(o=>o.v);
  const peakES = peaks.length ? (peaks[0]-peaks[peaks.length-1]) : null;
  sess.summary.peakES = peakES;

  // Auto-exclude extremes when ES exceeds limit
  if(state.esAutoExclude && Number.isFinite(peakES) && peakES > state.esLimit && peakPairs.length){
    const maxIdx = peakPairs[0].i;
    const minIdx = peakPairs[peakPairs.length-1].i;
    for(const idx of [maxIdx, minIdx]){
      const r = rounds[idx];
      if(!r) continue;
      r.excluded = true;
      r.flags = r.flags || [];
      r.flags.push(`ES > ${state.esLimit}lb`);
      if(r.diags && Array.isArray(r.diags)){
        if(!r.diags.includes("ES breach")) r.diags.unshift("ES breach");
      }else{
        r.diags = ["ES breach"];
      }
      // Treat as high anomaly driver for review without forcing Flyer
      r.score = Math.max(r.score, state.threshold + 0.15);
      r.bucket = clsFromScore(r.score);
    }
  }

  // apply user overrides (persist across re-runs)
  for(const r of rounds){
    r.excludedDerived = !!r.excluded;
    r.tagDerived = r.tag || "";
    if(r.userExcluded){
      r.excluded = true;
      r.flags = r.flags || [];
      if(!r.flags.includes("User excluded")) r.flags.push("User excluded");
      if(r.diags && Array.isArray(r.diags)){
        if(!r.diags.includes("User excluded")) r.diags.unshift("User excluded");
      } else {
        r.diags = ["User excluded"];
      }
    }
    const ut = (r.userTag||"").trim();
    if(ut){
      const t = `User:${ut}`;
      r.tag = r.tag ? (r.tag + ";" + t) : t;
    }
  }
  return sess;
}

function renderSessionOptions(){
  els.sessionSel.innerHTML = "";
  state.sessions.forEach((s, idx)=>{
    const opt = document.createElement('option');
    opt.value = String(idx);
    opt.textContent = `${s.name} (${s.summary.n} rounds)`;
    els.sessionSel.appendChild(opt);
  });
  els.sessionSel.value = String(state.activeIndex || 0);
}
function getActiveSession(){ return state.sessions[state.activeIndex] || null; }
function renderSessionsView(){
  // ensure summaries up to date
  state.sessions.forEach(s=>recomputeSessionPostFlags(s));
  if(!state.sessions.length){
    els.sessionsWrap.style.display='none';
    return;
  }
const rows = state.sessions.map((s,idx)=>({
    idx,
    name:s.name,
    n:s.summary.n,
    flyers:s.rounds.filter(r=>r.flyer).length,
    anomalies:s.rounds.filter(r=>r.score>=state.threshold).length
  }));

  // draw chart (median peak + ES)
els.sessionsTbody.innerHTML = rows.map((r,i)=>{
    return `<tr data-idx="${r.idx}">
      <td title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</td>
      <td class="mono">${r.n}</td>
      <td class="mono">${r.flyers}</td>
      <td class="mono">${r.anomalies}</td>
</tr>`;
  }).join("");
// click handler
  Array.from(els.sessionsTbody.querySelectorAll('tr')).forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const idx = Number(tr.getAttribute('data-idx'));
      if(Number.isFinite(idx)){
        state.activeIndex = idx;
        renderSessionOptions();
        // switch back to rounds view
        state.view='rounds';
        els.tabRounds.classList.add('active'); els.tabSessions.classList.remove('active'); if(els.tabCorr) els.tabCorr.classList.remove('active');
        els.sessionsWrap.style.display='none';
        els.tableWrap.style.display='block';
        render();
      }
    });
  });

}

function drawSessionChart(rows){
  const c = els.sessChart;
  if(!c) return;
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  // compute scales
  const medVals = rows.map(r=>r.peakMed).filter(v=>Number.isFinite(v));
  const esVals = rows.map(r=>r.peakES).filter(v=>Number.isFinite(v));
  if(!medVals.length && !esVals.length){
    ctx.fillStyle = 'rgba(255,255,255,.55)';
    ctx.font = '14px ui-sans-serif';
    ctx.fillText('No chartable values (need Peak Force values).', 12, 22);
    return;
  }
  const xPad=28, yPad=18, plotW=W-xPad*2, plotH=H-yPad*2;
  const minMed=Math.min(...medVals), maxMed=Math.max(...medVals);
  const minES=esVals.length?Math.min(...esVals):0, maxES=esVals.length?Math.max(...esVals):1;

  function x(i){ return xPad + (rows.length<=1? 0 : (i/(rows.length-1))*plotW); }
  function yMed(v){
    if(!Number.isFinite(v)) return null;
    const t = (v-minMed)/((maxMed-minMed)||1);
    return yPad + (1-t)*plotH;
  }
  function yES(v){
    if(!Number.isFinite(v)) return null;
    const t = (v-minES)/((maxES-minES)||1);
    return yPad + (1-t)*plotH;
  }

  // axes
  ctx.strokeStyle = 'rgba(255,255,255,.12)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(xPad, yPad);
  ctx.lineTo(xPad, yPad+plotH);
  ctx.lineTo(xPad+plotW, yPad+plotH);
  ctx.stroke();

  // line: med
  ctx.strokeStyle = 'rgba(124,220,255,.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  let started=false;
  rows.forEach((r,i)=>{
    const yy=yMed(r.peakMed);
    if(yy==null) return;
    const xx=x(i);
    if(!started){ ctx.moveTo(xx,yy); started=true; } else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // points: med
  ctx.fillStyle = 'rgba(124,220,255,.95)';
  rows.forEach((r,i)=>{
    const yy=yMed(r.peakMed); if(yy==null) return;
    const xx=x(i);
    ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill();
  });

  // line: ES
  ctx.strokeStyle = 'rgba(255,184,124,.75)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  started=false;
  rows.forEach((r,i)=>{
    const yy=yES(r.peakES);
    if(yy==null) return;
    const xx=x(i);
    if(!started){ ctx.moveTo(xx,yy); started=true; } else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // points: ES
  ctx.fillStyle = 'rgba(255,184,124,.9)';
  rows.forEach((r,i)=>{
    const yy=yES(r.peakES); if(yy==null) return;
    const xx=x(i);
    ctx.beginPath(); ctx.arc(xx,yy,3,0,Math.PI*2); ctx.fill();
  });

  // labels
  ctx.fillStyle = 'rgba(255,255,255,.55)';
  ctx.font = '12px ui-sans-serif';
  ctx.fillText('Peak Med', xPad+6, yPad+12);
  ctx.fillText('Peak ES', xPad+80, yPad+12);
}

function setupHeaderSort(){
  const headerMap = new Map([
    ["Trace","traceIndex"],
    ["Flyer","flyer"],
    ["Excluded","excluded"],
    ["Tag","tag"],
    ["Cause","cause"],
    ["Conf","conf"],
    ["Score","score"],
    ["Peak Force","peakForce"],
    ["Work Done","workDone"],
    ["Starting Pos","startingPos"],
    ["Terminal Force","terminalForce"],
    ["Early Spike","earlySpike"],
    ["Jagged","roughness"],
    ["End Flat","endFlat"],
    ["End Drop","endDrop"]
  ]);
  const ths = document.querySelectorAll("#tableWrap thead th");
  ths.forEach(th=>{
    const label = (th.textContent||"").trim();
    const field = headerMap.get(label);
    if(!field) return;
    th.style.cursor = "pointer";
    th.title = "Click to sort";
    th.addEventListener("click", ()=>{
      // toggle
      if(state.sortField === field){
        state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
      } else {
        state.sortField = field;
        // default directions: numeric desc, booleans true-first, strings asc
        const numericFields = new Set(["traceIndex","score","peakForce","workDone","startingPos","terminalForce","earlySpike","roughness","endFlat","endDrop","conf"]);
        if(numericFields.has(field)) state.sortDir = (field==="traceIndex") ? "asc" : "desc";
        else state.sortDir = "asc";
      }
      // mark sort mode
      state.sort = 'custom';
      if(els.sortSel) els.sortSel.value = 'custom';
      // visual hint
      ths.forEach(x=>x.classList.remove("sortedAsc","sortedDesc"));
      th.classList.add(state.sortDir==="asc" ? "sortedAsc" : "sortedDesc");
      render();
    });
  });
}

function exportSessionsCSV(){
  const csvCellLocal = (v)=>{
    let s = (v==null) ? "" : String(v);
    if(/[",\n]/.test(s)) s = `"${s.replace(/"/g,'""')}"`;
    return s;
  };
const header = ["Session","Rounds","Flyers","Anomalies","Peak Med","Peak ES","Work Med"].concat(anyCurves ? ["Rough Med"] : []);
  const lines = exportPreambleLines("shown_rounds").concat([header.join(",")]);
  const anyCurves2 = state.sessions.some(s=>!!s.hasCurves);
  for(const s of state.sessions){
    const base = [
      s.name,
      s.summary.n,
      s.rounds.filter(r=>r.flyer).length,
      s.rounds.filter(r=>r.score>=state.threshold).length,
      s.summary.peakMed==null? "": s.summary.peakMed,
      s.summary.peakES==null? "": s.summary.peakES,
      s.summary.workMed==null? "": s.summary.workMed
    ];
    const extra = anyCurves2 ? [ (s.summary.roughMed==null? "": s.summary.roughMed) ] : [];
    const row = base.concat(extra).map(csvCellLocal).join(",");
    lines.push(row);
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = "amp_sessions_summary.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function matchesQuery(r, q){
  if(!q) return true;
  q = q.toLowerCase();
  return (
    String(r.trace).toLowerCase().includes(q) ||
    String(r.driver).toLowerCase().includes(q) ||
    String(r.cause).toLowerCase().includes(q) ||
    String(r.diags.join(" ")).toLowerCase().includes(q)
  );
}

function renderTraceChart(){
  const c = els.traceChart;
  if(!c) return;
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);
  state.tcPoints = [];

  const sess = getActiveSession();
  if(!sess || !sess.rounds || !sess.rounds.length){
    ctx.fillStyle = 'rgba(255,255,255,.55)';
    ctx.font = '14px ui-sans-serif';
    ctx.fillText('Load a session to see the trace chart.', 12, 22);
    return;
  }

  let rounds = (state.traceChart && state.traceChart.useFiltered) ? (state.shownRows||[]) : sess.rounds.slice();
  if(!(state.traceChart && state.traceChart.showExcluded)){
    rounds = rounds.filter(r=>!r.excluded);
  }
  drawTraceChart(rounds, {overlayWork: !!(state.traceChart && state.traceChart.overlayWork)});
}

/* ========== detected fields summary + inspector ========== */
function setImportReport(report){
  state.lastImportReport = report || null;
  renderDetectSummary();
}
function renderDetectSummary(){
  if(!els.detectSummary) return;
  const rep = state.lastImportReport;
  if(!rep){
    els.detectSummary.style.display = "none";
    return;
  }
  els.detectSummary.style.display = "block";
  els.detectSummaryTitle.textContent = rep.title || "";
  els.detectSummaryBody.innerHTML = rep.html || "";
}

function updateWizardUI(opts={}){
  const w = els.wizard;
  if(!w) return;
  const steps = Array.from(w.querySelectorAll('.wizStep'));
  const hasSessions = !!(state.sessions && state.sessions.length);
  const hasReport = !!state.lastImportReport;
  const exported = !!state._wizardExported;

  // Determine step focus:
  // 1 active until any import attempt happens
  // 2 done when we have a detect report
  // 3 active when sessions exist
  // 4 done when user exports
  const importAttempted = !!state._wizardImportedOnce;

  steps.forEach(st=>{
    st.classList.remove('done','active');
    const n = Number(st.getAttribute('data-step')||'0');
    if(n===1){
      if(importAttempted) st.classList.add('done');
      else st.classList.add('active');
    }
    if(n===2){
      if(hasReport) st.classList.add('done');
      else if(importAttempted) st.classList.add('active');
    }
    if(n===3){
      if(hasSessions) st.classList.add('active');
    }
    if(n===4){
      if(exported) st.classList.add('done');
    }
  });
}

function markExported(){
  state._wizardExported = true;
  updateWizardUI();
}

function diagnoseAMP(rows){
  try{
    const want = ["Peak Force","Work Done","Starting Pos","Terminal Force","Flyer"];
    const found = {};
    want.forEach(k=>found[k]=false);
    let scanN = 0;
    for(const row of rows||[]){
      scanN++;
      const a = String((row && row[0]) ?? "").toLowerCase();
      if(a.includes("peak force")) found["Peak Force"]=true;
      if(a.includes("work done")) found["Work Done"]=true;
      if(a.includes("starting pos") || a.includes("starting position")) found["Starting Pos"]=true;
      if(a.includes("terminal force")) found["Terminal Force"]=true;
      if(a==="flyer" || a.includes("flyer")) found["Flyer"]=true;
      if(scanN>2000) break;
    }
    // quick sniff for curve blocks: many numeric rows with multiple numeric cols
    let numericRich = 0;
    for(const row of (rows||[]).slice(0,300)){
      let nums = 0;
      for(let i=0;i<Math.min(10,(row||[]).length);i++){
        const v = parseFloat(String(row[i]??"").replace(/[^0-9+\-.eE]/g,''));
        if(Number.isFinite(v)) nums++;
      }
      if(nums>=3) numericRich++;
    }
    const hasCurveLike = numericRich >= 10;
    const missing = want.filter(k=>!found[k]).join(", ");
    const ok = want.filter(k=>found[k]).join(", ");
    return [
      `Found metric rows: ${ok || "—"}`,
      missing ? `Missing rows: ${missing}` : `Missing rows: —`,
      `Curve-like numeric block: ${hasCurveLike ? "likely yes" : "not detected"}`
    ].join("\n");
  }catch(e){
    return "";
  }
}

function bindRowSelection(){
  if(!els.tbody) return;
  const trs = els.tbody.querySelectorAll('tr[data-traceindex]');
  trs.forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const ti = parseInt(tr.dataset.traceindex, 10);
      if(!Number.isFinite(ti)) return;
      state.selectedTraceIndex = ti;
      render();
    });
  });
}

function getSelectedRound(sess){
  if(!sess) return null;
  const ti = state.selectedTraceIndex;
  if(!Number.isFinite(ti)) return null;
  return sess.rounds.find(r=>r.traceIndex===ti) || null;
}

function renderInspector(){
  if(!els.inspectorWrap) return;
  const sess = getActiveSession();
  const r = getSelectedRound(sess);
  if(!sess || !r){
    els.inspectorWrap.style.display = "none";
    return;
  }
  els.inspectorWrap.style.display = "block";

  const conf = confLabel(r.conf);
  els.insTitle.textContent = `${r.trace || ("Trace "+r.traceIndex)} • conf: ${conf}`;
  els.insBucket.textContent = String(r.bucket||"normal");
  els.insBucket.className = `badge ${r.bucket==='flyer'?'bad':(r.bucket==='anom'?'warn':(r.bucket==='watch'?'mid':'good'))}`;
  els.insScore.textContent = fmt(r.score, 2);
  els.insDriver.textContent = r.driver || "—";
  els.insCause.textContent = r.cause || "—";
  els.insWhy.textContent = r.causeExplain || "—";

  const vals = [
    `PF=${fmt(r.peakForce,3)}`,
    `WD=${fmt(r.workDone,3)}`,
    `SP=${fmt(r.startingPos,3)}`,
    `TF=${fmt(r.terminalForce,3)}`
  ];
  if(r.curve && r.curve.x && r.curve.x.length){
    vals.push(`CurvePts=${r.curve.x.length}`);
  }
  els.insVals.textContent = vals.join(" • ");

  const derived = !!r.excludedDerived;
  const userEx = !!r.userExcluded;
  els.insUserExcluded.checked = userEx;
  const whyParts = [];
  if(derived){
    const esFlag = (r.flags||[]).find(f=>String(f).startsWith("ES >"));
    whyParts.push(esFlag ? `Derived: ${esFlag}` : "Derived: excluded");
  }
  if(userEx) whyParts.push("User: manually excluded");
  if(!whyParts.length) whyParts.push("Not excluded");
  els.insExcludedWhy.textContent = whyParts.join(" • ");

  const ut = (r.userTag||"").trim();
  els.insTag.value = ut;
  const tags = (r.tag ? r.tag.split(";").filter(Boolean) : []);
  els.insTags.textContent = tags.length ? tags.join(", ") : "—";

  const z = r.z || {};
  const keys = [
    ["peakForce","Peak Force"],
    ["workDone","Work Done"],
    ["terminalForce","Terminal Force"],
    ["startingPos","Starting Pos"],
    ["earlySpike","Early spike"],
    ["roughness","Jaggedness"],
    ["endFlat","End flat"],
    ["endDrop","End drop"],
    ["midSlope","Mid slope"],
  ];
  const lines = keys
    .filter(([k])=> (z[k]!==undefined && z[k]!==null))
    .map(([k,lab])=> `${lab.padEnd(14,' ')} ${((z[k]>=0)?'+':'')}${Number(z[k]).toFixed(2)}σ`);
  els.insZ.textContent = lines.length ? lines.join("\n") : "—";

  const shown = (state.shownRows||[]).some(rr=>rr.traceIndex===r.traceIndex);
  if(!shown){
    els.insZ.textContent = (els.insZ.textContent==="—" ? "" : (els.insZ.textContent+"\n")) + "(note) this trace is currently filtered out of the table";
  }
  if(els.insAdvice){
    try{
      const reasons = [];
      if(Number.isFinite(r.score) && r.score >= state.threshold) reasons.push(`Score ${fmt(r.score,2)} ≥ threshold ${fmt(state.threshold,2)}`);
      if(r.flyer) reasons.push("Marked as Flyer (mechanical outlier)");
      if(r.excluded) reasons.push("Auto-excluded by ES rule (Peak Force ES limit)");
      if(r.userExcluded) reasons.push("Manually excluded by you");
      if(r.driver) reasons.push(`Driver: ${escapeHtml(r.driver)}`);
      if(r.cause && r.cause!=='—') reasons.push(`Cause: ${escapeHtml(r.cause)}`);

      const z = r.z || {};
      const ds = r.diagStrength || {};
      const strong = (v)=> (Number.isFinite(v) && v >= 1.3);
      const earlyStrong = strong(ds.earlySpike) || strong(z.earlySpike);
      const jagStrong   = strong(ds.jagged)    || strong(z.roughness);
      const flatStrong  = strong(ds.endFlat)   || strong(z.endFlat);
      const dropStrong  = strong(ds.endDrop)   || strong(z.endDrop);
      const pfHi = Number.isFinite(z.peakForce) && z.peakForce >= 1.3;
      const pfLo = Number.isFinite(z.peakForce) && z.peakForce <= -1.3;

      const checks = [];
      if(earlyStrong){
        checks.push("Inspect case mouth chamfer/burrs; look for a donut or neck/junction step.");
        checks.push("Clean the seating stem and check for carbon at the case mouth / neck.");
      }
      if(jagStrong){
        checks.push("Clean seating die / stem; check for debris or carbon causing ‘gritty’ seating.");
        checks.push("Check neck-wall thickness / neck tension uniformity (bushing/expander).");
      }
      if(flatStrong || dropStrong){
        checks.push("Check seating alignment (runout) and that the stem matches the bullet ogive.");
        checks.push("Verify consistent neck tension + anneal; these patterns often show sensitivity near final seating.");
      }
      if(pfHi){
        checks.push("Peak Force high: neck tension may be high/dry — consider light neck lube or bushing/expander tweak.");
      }
      if(pfLo){
        checks.push("Peak Force low: neck tension may be light — verify sizing, expander, and brass springback/anneal.");
      }
      if(!checks.length){
        checks.push("Compare this trace to nearby ‘normal’ traces in the Trace chart; look for one metric that pops.");
        checks.push("If this repeats across many traces, it’s likely process-related; if isolated, it’s a one-off (debris/burr).");
      }

      const ul = (arr)=> `<ul style="margin:6px 0 0 18px; padding:0">` + arr.map(x=>`<li style="margin:4px 0">${escapeHtml(String(x))}</li>`).join("") + `</ul>`;
      els.insAdvice.innerHTML =
        `<div><strong>Why this got flagged</strong></div>` +
        (reasons.length ? ul(reasons) : `<div class="small muted" style="margin-top:6px">—</div>`) +
        `<div style="margin-top:10px"><strong>What to check next</strong></div>` +
        ul(checks);
    }catch(e){
      els.insAdvice.textContent = "—";
    }
  }

}

function drawTraceChart(rounds, opts){
  const c = els.traceChart;
  if(!c) return;
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  const peak = rounds.map(r=>r.peakForce).filter(v=>Number.isFinite(v));
  if(!peak.length){
    ctx.fillStyle = 'rgba(255,255,255,.55)';
    ctx.font = '14px ui-sans-serif';
    ctx.fillText('No Peak Force values to chart.', 12, 22);
    return;
  }
  const work = rounds.map(r=>r.workDone).filter(v=>Number.isFinite(v));
  const overlayWork = !!opts.overlayWork && work.length>1;

  const xPad=34, yPad=18, plotW=W-xPad*2, plotH=H-yPad*2;

  const minX = Math.min(...rounds.map(r=>r.traceIndex||0)), maxX = Math.max(...rounds.map(r=>r.traceIndex||0));
  const minP = Math.min(...peak), maxP = Math.max(...peak);
  const pPad = (maxP-minP)*0.08 || 1;
  const yMinP = minP - pPad, yMaxP = maxP + pPad;

  let yMinW=0, yMaxW=1;
  if(overlayWork){
    const minW=Math.min(...work), maxW=Math.max(...work);
    const wPad=(maxW-minW)*0.08 || 0.01;
    yMinW=minW-wPad; yMaxW=maxW+wPad;
  }

  const x = (xi)=>{
    const t = (xi-minX)/((maxX-minX)||1);
    return xPad + t*plotW;
  };
  const yP = (v)=>{
    const t = (v-yMinP)/((yMaxP-yMinP)||1);
    return yPad + (1-t)*plotH;
  };
  const yW = (v)=>{
    const t = (v-yMinW)/((yMaxW-yMinW)||1);
    return yPad + (1-t)*plotH;
  };

  // axes
  ctx.strokeStyle = 'rgba(255,255,255,.12)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(xPad, yPad);
  ctx.lineTo(xPad, yPad+plotH);
  ctx.lineTo(xPad+plotW, yPad+plotH);
  ctx.stroke();

  // y labels (minimal)
  ctx.fillStyle = 'rgba(255,255,255,.45)';
  ctx.font = '12px ui-sans-serif';
  ctx.fillText('Peak', 8, 22);
  if(overlayWork) ctx.fillText('Work', 8, 38);

  // ES bounds (Peak Force) + ES-limit band
  const peakValsAll = rounds.map(r=>r.peakForce).filter(v=>Number.isFinite(v));
  const minPeakAll = peakValsAll.length ? Math.min(...peakValsAll) : null;
  const maxPeakAll = peakValsAll.length ? Math.max(...peakValsAll) : null;
  const esAll = (minPeakAll!=null && maxPeakAll!=null) ? (maxPeakAll-minPeakAll) : null;
  if(esAll!=null){
    const yMin = yP(minPeakAll), yMax = yP(maxPeakAll);
    ctx.save();
    ctx.setLineDash([6,4]);
    ctx.strokeStyle = 'rgba(255,255,255,.14)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(xPad, yMin); ctx.lineTo(xPad+plotW, yMin); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(xPad, yMax); ctx.lineTo(xPad+plotW, yMax); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(255,255,255,.45)';
    ctx.font = '12px ui-sans-serif';
    ctx.fillText('Peak ES: '+fmt(esAll,1)+' lb', xPad+8, yPad+12);
    ctx.restore();

    // ES limit band around median (if set)
    if(Number.isFinite(state.esLimit) && state.esLimit>0){
      const med = median(peakValsAll);
      const half = state.esLimit/2;
      const yLo = yP(med-half), yHi = yP(med+half);
      ctx.save();
      ctx.setLineDash([3,5]);
      ctx.strokeStyle = 'rgba(124,220,255,.18)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(xPad, yLo); ctx.lineTo(xPad+plotW, yLo); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(xPad, yHi); ctx.lineTo(xPad+plotW, yHi); ctx.stroke();
      ctx.fillStyle = 'rgba(124,220,255,.45)';
      ctx.font = '12px ui-sans-serif';
      ctx.fillText('ES limit band (±'+fmt(half,1)+' lb)', xPad+8, yPad+26);
      ctx.restore();
    }
  }

  // Peak line
  ctx.strokeStyle = 'rgba(124,220,255,.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  let started=false;
  rounds.slice().sort((a,b)=>(a.traceIndex||0)-(b.traceIndex||0)).forEach((r)=>{
    if(!Number.isFinite(r.peakForce)) return;
    const xx=x(r.traceIndex||0), yy=yP(r.peakForce);
    if(!started){ ctx.moveTo(xx,yy); started=true; } else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // Work line (optional)
  if(overlayWork){
    ctx.strokeStyle = 'rgba(255,180,92,.78)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    started=false;
    rounds.slice().sort((a,b)=>(a.traceIndex||0)-(b.traceIndex||0)).forEach((r)=>{
      if(!Number.isFinite(r.workDone)) return;
      const xx=x(r.traceIndex||0), yy=yW(r.workDone);
      if(!started){ ctx.moveTo(xx,yy); started=true; } else ctx.lineTo(xx,yy);
    });
    ctx.stroke();
  }

  // Points / highlights
  rounds.forEach((r)=>{
    const xi=r.traceIndex||0;
    if(!Number.isFinite(r.peakForce)) return;
    const xx=x(xi), yy=yP(r.peakForce);

    // base style
    let fill='rgba(124,220,255,.92)';
    let stroke=null, lw=2, rad=4;

    if(r.excluded){
      fill='rgba(200,200,210,.55)';
      rad=3.5;
    }
    if(r.tag==="Top5"){
      fill='rgba(96,205,255,.95)';
      rad=5;
    }else if(r.tag==="Bottom5"){
      fill='rgba(120,255,170,.92)';
      rad=5;
    }
    if(r.flyer){
      stroke='rgba(255,90,90,.95)';
      lw=2.5;
      rad=5.5;
    }

    ctx.beginPath();
    ctx.arc(xx,yy,rad,0,Math.PI*2);
    ctx.fillStyle=fill;
    ctx.fill();
    if(stroke){
      ctx.strokeStyle=stroke;
      ctx.lineWidth=lw;
      ctx.stroke();
    }
  });

  // Legend (tiny)
  ctx.fillStyle='rgba(255,255,255,.52)';
  ctx.font='12px ui-sans-serif';
  ctx.fillText('Peak Force', xPad+8, yPad+14);
  if(overlayWork) ctx.fillText('Work Done', xPad+92, yPad+14);
}

function showFloatTip(html, x, y){
  const tip = document.getElementById('floatTip');
  if(!tip) return;
  tip.innerHTML = html;
  tip.style.display = 'block';
  const pad = 12;
  const vw = window.innerWidth, vh = window.innerHeight;
  // measure
  tip.style.left = '0px'; tip.style.top = '0px';
  const rect = tip.getBoundingClientRect();
  let left = x + pad;
  let top = y + pad;
  if(left + rect.width + pad > vw) left = x - rect.width - pad;
  if(top + rect.height + pad > vh) top = y - rect.height - pad;
  left = Math.max(pad, Math.min(vw - rect.width - pad, left));
  top = Math.max(pad, Math.min(vh - rect.height - pad, top));
  tip.style.left = left + 'px';
  tip.style.top = top + 'px';
}
function hideFloatTip(){
  const tip = document.getElementById('floatTip');
  if(tip) tip.style.display = 'none';
}

function initInfoTips(){
  const tips = Array.from(document.querySelectorAll('.infoTip[data-tip]'));
  if(!tips.length) return;
  tips.forEach(el=>{
    el.addEventListener('mouseenter', (e)=>{
      const t = el.getAttribute('data-tip') || '';
      showFloatTip(`<div style="max-width:260px">${escapeHtml(t)}</div>`, e.clientX, e.clientY);
    });
    el.addEventListener('mousemove', (e)=>{
      const t = el.getAttribute('data-tip') || '';
      showFloatTip(`<div style="max-width:260px">${escapeHtml(t)}</div>`, e.clientX, e.clientY);
    });
    el.addEventListener('mouseleave', ()=>hideFloatTip());
  });
}
function initTraceChartHover(){
  const c = els.traceChart;
  if(!c) return;
  c.addEventListener('mouseleave', ()=>{ hideFloatTip(); });
  c.addEventListener('mousemove', (ev)=>{
    const rect = c.getBoundingClientRect();
    const mx = (ev.clientX - rect.left) * (c.width / rect.width);
    const my = (ev.clientY - rect.top) * (c.height / rect.height);
    // find nearest point
    let best = null, bestD = 1e9;
    for(const p of (state.tcPoints||[])){
      const dx = p.x - mx, dy = p.y - my;
      const d = dx*dx + dy*dy;
      if(d < bestD){ bestD=d; best=p; }
    }
    const hit = best && bestD <= (9*9);
    if(!hit){ hideFloatTip(); return; }
    const r = best.r;
    const why = (r.whyList && r.whyList.length) ? r.whyList.join(', ') : (r.why||'—');
    const html = `
      <div style="font-weight:700; margin-bottom:6px">Trace ${escapeHtml(String(r.traceIndex||r.trace||''))}</div>
      <div class="mono" style="opacity:.9">Peak: ${fmt(r.peakForce,3)} lb</div>
      <div class="mono" style="opacity:.9">Work: ${fmt(r.workDone,3)} • Start: ${fmt(r.startingPos,3)} • Term: ${fmt(r.terminalForce,3)}</div>
      <div style="margin-top:6px">
        <span class="chip">${r.flyer?'Flyer':'No flyer'}</span>
        <span class="chip">${r.excluded?'Excluded':'Included'}</span>
        ${r.tag?`<span class="chip">${escapeHtml(r.tag)}</span>`:''}
      </div>
      <div style="margin-top:6px; opacity:.9">Score: <span class="mono">${fmt(r.score,2)}</span> • Cause: ${escapeHtml(r.cause||'—')} • Conf: ${escapeHtml(confLabel((r.confidence!=null? r.confidence : (r.conf!=null? r.conf : 0))))}</div>
      <div style="margin-top:6px; opacity:.85">Why: ${escapeHtml(why)}</div>
    `;
    showFloatTip(html, ev.clientX, ev.clientY);
  });
}

function sortRounds(a,b){
  // Header-click sort takes precedence
  if(state.sortField){
    const f = state.sortField;
    const dir = state.sortDir === "asc" ? 1 : -1;
    const av = a[f];
    const bv = b[f];
    // booleans
    if(typeof av === "boolean" || typeof bv === "boolean"){
      const aa = av ? 1 : 0;
      const bb = bv ? 1 : 0;
      return (aa - bb) * dir;
    }
    // numbers
    if(Number.isFinite(av) || Number.isFinite(bv)){
      const aa = Number.isFinite(av) ? av : -1e18;
      const bb = Number.isFinite(bv) ? bv : -1e18;
      return (aa - bb) * dir;
    }
    // strings
    const aa = (av==null) ? "" : String(av);
    const bb = (bv==null) ? "" : String(bv);
    return aa.localeCompare(bb) * dir;
  }

  const key = state.sort;
  if(key==="score_desc") return b.score - a.score;
  if(key==="score_asc") return a.score - b.score;
  if(key==="trace_asc") return a.traceIndex - b.traceIndex;
  if(key==="trace_desc") return b.traceIndex - a.traceIndex;
  if(key==="peak_desc") return (b.peakForce??-1e9) - (a.peakForce??-1e9);
  if(key==="work_desc") return (b.workDone??-1e9) - (a.workDone??-1e9);
  if(key==="rough_desc") return (b.roughness??-1e9) - (a.roughness??-1e9);
  return b.score - a.score;
}
function confLabel(c){
  if(!Number.isFinite(c) || c<=0) return "—";
  if(c>=0.85) return "high";
  if(c>=0.65) return "med";
  return "low";
}

function diagTip(label){
  const m = {
    "Flyer":"Flyer: this trace is a mechanical outlier vs the session baseline (robust outlier test). Consider segregating or re-prepping.",
    "Force outlier":"Force outlier: Peak Force / Work / Position deviates strongly from the session median (robust z-score).",
    "Early spike":"Early spike: unusually high resistance early in seating (possible rough mouth, insufficient chamfer, or neck donut contact).",
    "Jagged":"Jagged: high curve roughness (possible carbon, inconsistent neck wall, corrosion, or damage).",
    "End flat":"End flat: reduced slope near end of seating (often normal bearing-surface behavior; watch consistency).",
    "End drop":"End drop: downward trend at end of seating (often normal; can indicate transition in bearing surface contact)."
  };
  if(m[label]) return m[label];
  if(label && label.startsWith("End")) return "End-of-stroke feature: compare consistency across the batch.";
  if(label && label.includes("ES")) return "ES rule: batch extreme spread exceeded the configured limit.";
  return "Diagnostic flag";
}
function tagTip(tag){
  if(tag==="Top5") return "Top5: one of the five HIGHEST Peak Force traces in this session (by Peak Force).";
  if(tag==="Bottom5") return "Bottom5: one of the five LOWEST Peak Force traces in this session (by Peak Force).";
  return "Tag";
}
function diagBadges(r){
  const parts = (r.diags||[]).slice();
  const flags = (r.flags||[]);
  for(const f of flags){ if(f==="Top5"||f==="Bottom5") continue; if(!parts.includes(f)) parts.push(f); }
  const out = parts.map(p=>{
    const dot = p==="Flyer" ? "bad" :
                p==="Force outlier" ? "warn" :
                (p==="Early spike" || p==="Jagged" || p.startsWith("End")) ? "mid" :
                "good";
    return `<span class="badge" title="${escapeHtml(diagTip(p))}"><span class="dot ${dot}"></span>${escapeHtml(p)}</span>`;
  });
  return out.join(" ");
}

function render(){
  const sess = getActiveSession();
  if(!sess){
    els.empty.style.display="block";
    els.tableWrap.style.display="none";
    els.kN.textContent="—"; els.kA.textContent="—"; if(els.kF) els.kF.textContent="—";
    els.sessLabel.textContent="—"; els.sessLabel.title="—"; els.sessMeta.textContent="—";
els.baseChip.textContent = `Baseline: ${state.baselineMode}`;
    els.showChip.textContent = "Shown: —";
    if(els.filterChip){ els.filterChip.style.display="none"; els.filterChip.textContent="Filters: —"; }
    if(els.inspectorWrap) els.inspectorWrap.style.display = "none";
    return;
  }

  els.empty.style.display="none";
  els.tableWrap.style.display="block";

  // header label (ellipsis)
  els.sessLabel.textContent = sess.name;
  els.sessLabel.title = sess.name;
  els.sessMeta.textContent = `${sess.summary.n} rounds • ${sess.summary.anomalies} anomalies • ${sess.summary.flyers||0} flyers`;
els.baseChip.textContent = `Baseline: ${state.baselineMode === "custom" ? (state.baseline ? "saved" : "none") : state.baselineMode}`;
  els.kN.textContent = sess.summary.n;
  els.kA.textContent = sess.rounds.filter(r=>r.score>=state.threshold).length;
  if(els.kF) els.kF.textContent = (sess.rounds.filter(r=>r.flyer).length);
// sync trace chart controls
  if(els.tcOverlayWork) els.tcOverlayWork.checked = !!state.traceChart.overlayWork;
  if(els.tcUseFiltered) els.tcUseFiltered.checked = !!state.traceChart.useFiltered;
  if(els.tcShowExcluded) els.tcShowExcluded.checked = !!state.traceChart.showExcluded;

  const isActionable = (r)=> (r.score>=state.threshold) || !!r.flyer || !!r.excluded;

  const rows = sess.rounds
    .filter(r=>(!state.onlyAnom || r.score>=state.threshold))
    .filter(r=>(!state.onlyActionable || isActionable(r)))
    .filter(r=>(!state.onlyFlyers || !!r.flyer))
    .filter(r=>(!state.hideExcluded || !r.excluded))
    .filter(r=>matchesQuery(r, state.query))
    .slice()
    .sort(sortRounds);

  state.shownRows = rows;
  els.showChip.textContent = `Shown: ${rows.length}`;
  // active filter indicator
  if(els.filterChip){
    const f=[];
    if(state.onlyActionable) f.push("Actionable");
    if(state.onlyAnom) f.push("Anomalies");
    if(state.hideExcluded) f.push("No excluded");
    if(state.query && String(state.query).trim()) f.push("Search");
    els.filterChip.style.display = f.length ? "inline-flex" : "none";
    els.filterChip.textContent = `Filters: ${f.length ? f.join(" + ") : "—"}`;
  }

  const body = rows.map((r,i)=>{
    const cls = clsFromScore(r.score);
    const flyerTxt = r.flyer ? "true" : "false";
    const conf = confLabel(r.conf);
    const early = (r.diagStrength && r.diagStrength.earlySpike) ? strengthGlyph(r.diagStrength.earlySpike) : (r.earlySpike!=null ? "•" : "—");
    const rough = (r.diagStrength && r.diagStrength.jagged) ? strengthGlyph(r.diagStrength.jagged) : (r.roughness!=null ? "•" : "—");
    const flat  = (r.diagStrength && r.diagStrength.endFlat) ? strengthGlyph(r.diagStrength.endFlat) : (r.endFlat!=null ? "•" : "—");
    const drop  = (r.diagStrength && r.diagStrength.endDrop) ? strengthGlyph(r.diagStrength.endDrop) : (r.endDrop!=null ? "•" : "—");
    const earlyTip = (r.z && r.z.earlySpike!=null) ? `Early spike z=${fmt(r.z.earlySpike,2)}` : (r.earlySpike!=null ? `Early spike=${fmt(r.earlySpike,3)}` : "Early spike: —");
    const roughTip = (r.z && r.z.roughness!=null) ? `Jaggedness z=${fmt(r.z.roughness,2)}` : (r.roughness!=null ? `Jaggedness=${fmt(r.roughness,4)}` : "Jaggedness: —");
    const flatTip  = (r.z && r.z.endFlat!=null) ? `End flat z=${fmt(r.z.endFlat,2)}` : (r.endFlat!=null ? `End flat=${fmt(r.endFlat,4)}` : "End flat: —");
    const dropTip  = (r.z && r.z.endDrop!=null) ? `End drop z=${fmt(r.z.endDrop,2)}` : (r.endDrop!=null ? `End drop=${fmt(r.endDrop,4)}` : "End drop: —");
    const exTxt = r.excluded ? "true" : "false";
    const tagHtml = (r.tag ? r.tag.split(";").filter(Boolean) : []).map(tg=>{
      const tip = (tg==="Top5") ? "Tag: one of the five HIGHEST Peak Force traces in this session"
                : (tg==="Bottom5") ? "Tag: one of the five LOWEST Peak Force traces in this session"
                : (String(tg).startsWith("User:")) ? "User note tag"
                : "Tag";
      const dot = (tg==="Top5") ? "good" : (tg==="Bottom5") ? "mid" : "warn";
      return `<span class="badge" title="${escapeHtml(tip)}"><span class="dot ${dot}"></span>${escapeHtml(tg)}</span>`;
    }).join(" ") || "—";
    return `<tr class="${cls} ${r.excluded?'excluded':''} ${(state.selectedTraceIndex===r.traceIndex)?'selected':''}" data-idx="${i}" data-traceindex="${r.traceIndex}">
      <td class="mono" data-col="trace">${escapeHtml(r.trace)}</td>
      <td data-col="flyer"><span class="badge" title="Flyer: mechanical outlier vs session baseline (force/position/work)."><span class="dot ${r.flyer?'bad':'good'}"></span>${flyerTxt}</span></td>
      <td data-col="excluded"><span class="badge" title="Excluded: removed by ES rule or manual exclusion; still tracked for review/export."><span class="dot ${r.excluded?'warn':'good'}"></span>${exTxt}</span></td>
      <td data-col="tag">${tagHtml}</td>
      <td data-col="why"><span title="${escapeAttr(r.whyLine||r.causeExplain||'—')}">${diagBadges(r)}</span></td>
      <td data-col="cause"><span title="${escapeAttr(r.causeExplain||'—')}">${escapeHtml((r.cause && r.cause!=='—') ? r.cause : '—')}</span></td>
      <td data-col="conf"><span class="badge" title="Confidence: how strongly the data supports the Cause label."><span class="dot ${conf==='high'?'bad':conf==='med'?'warn':conf==='low'?'mid':'good'}"></span>${conf}</span></td>
      <td class="mono" data-col="score">${fmt(r.score,2)}</td>
      <td data-col="driver">${escapeHtml(r.driver)}</td>
      <td class="mono" data-col="peak">${fmt(r.peakForce,3)}</td>
      <td class="mono" data-col="work">${fmt(r.workDone,3)}</td>
      <td class="mono" data-col="startPos">${fmt(r.startingPos,3)}</td>
      <td class="mono" data-col="termForce">${fmt(r.terminalForce,3)}</td>
      <td class="mono curveCol" data-col="earlySpike" title="${escapeAttr(earlyTip)}">${early}</td>
      <td class="mono curveCol" data-col="jagged" title="${escapeAttr(roughTip)}">${rough}</td>
      <td class="mono curveCol" data-col="endFlat" title="${escapeAttr(flatTip)}">${flat}</td>
      <td class="mono curveCol" data-col="endDrop" title="${escapeAttr(dropTip)}">${drop}</td>
    </tr>`;
  }).join("");

  els.tbody.innerHTML = body;
  bindRowSelection();
  renderInspector();
  if(els.btnClearSort){
    const on = !!state.sortField;
    els.btnClearSort.disabled = !on;
    els.btnClearSort.style.opacity = on ? 1 : 0.55;
  }
  renderTraceChart();
}

/* ========== export ========== */
function csvCell(v){
  const s = String(v ?? "");
  if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function buildShownCSV(){
  const rows = state.shownRows || [];
  if(!rows.length) return "";
  const sess = getActiveSession();
  const includeCurves = !!(sess && sess.hasCurves);

  const defs = {
    trace:      { label:"Trace", val:(r)=>r.trace },
    flyer:      { label:"Flyer", val:(r)=>(r.flyer ? "Yes" : "No") },
    excluded:   { label:"Excluded", val:(r)=>((r.excluded||r.userExcluded) ? "Yes" : "No") },
    tag:        { label:"Tag", val:(r)=> (r.userTag || r.tag || "") },
    why:        { label:"Why", val:(r)=> (r.whyLine || "") },
    cause:      { label:"Cause", val:(r)=> (r.causeExplain || r.cause || "") },
    conf:       { label:"Conf", val:(r)=> confLabel(r.conf) },
    score:      { label:"Score", val:(r)=> fmt(r.score,2) },
    driver:     { label:"Driver", val:(r)=> (r.driver || "") },
    peak:       { label:"Peak Force", val:(r)=> fmt(r.peakForce,3) },
    work:       { label:"Work Done", val:(r)=> fmt(r.workDone,3) },
    startPos:   { label:"Starting Pos", val:(r)=> fmt(r.startingPos,3) },
    termForce:  { label:"Terminal Force", val:(r)=> fmt(r.terminalForce,3) },
    earlySpike: { label:"Early Spike", val:(r)=> (r.earlySpike==null? "" : r.earlySpike) },
    jagged:     { label:"Jaggedness", val:(r)=> (r.roughness==null? "" : r.roughness) },
    endFlat:    { label:"End Flat", val:(r)=> (r.endFlat==null? "" : r.endFlat) },
    endDrop:    { label:"End Drop", val:(r)=> (r.endDrop==null? "" : r.endDrop) },
  };

  let cols = Array.isArray(state.visibleCols) ? state.visibleCols.slice() : (COL_ESSENTIALS||[]).slice();
  if(!includeCurves) cols = cols.filter(k=>!['earlySpike','jagged','endFlat','endDrop'].includes(k));

  const header = ["Session"].concat(cols.map(k=> (defs[k] ? defs[k].label : k)));
  const lines = exportPreambleLines("shown_rounds").concat([header.map(csvCell).join(",")]);

  for(const r of rows){
    const base = [sess ? sess.name : ""].concat(cols.map(k=> (defs[k] ? defs[k].val(r) : "")));
    lines.push(base.map(csvCell).join(","));
  }
  return lines.join("\n");
}

function exportShown(){
  const csv = buildShownCSV();
  if(!csv) return;
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = "amp_anomaly_shown.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function flashStatus(msg){
  try{
    const el = document.getElementById('showChip');
    if(!el) return;
    const prev = el.textContent;
    el.textContent = msg;
    el.style.background = 'rgba(255,255,255,.16)';
    setTimeout(()=>{ el.textContent = prev; el.style.background = ''; }, 1800);
  }catch(e){}
}

async function copyShown(){
  const csv = buildShownCSV();
  if(!csv) return;
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(csv);
      flashStatus("Copied CSV ✓");
      return;
    }
  }catch(e){}
  // Fallback
  try{
    const ta = document.createElement('textarea');
    ta.value = csv;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    document.execCommand('copy');
    ta.remove();
    flashStatus("Copied CSV ✓");
  }catch(e){
    flashStatus("Copy failed");
  }
}

function clearHeaderSort(){
  state.sortField = null;
  state.sortDir = null;
  document.querySelectorAll('th').forEach(x=>x.classList.remove('sortedAsc','sortedDesc'));
  saveSettings();
  render();
}

/* ========== file loading ========== */
async function loadFiles(fileList){
  const files = Array.from(fileList || []);
  state._wizardImportedOnce = true;
  updateWizardUI();
  if(!files.length) return;
  const newSessions = [];
  let failCount = 0;
  const perFile = [];
  for(const f of files){
    const txt = await f.text();
    const rows = parseCSV(txt);
    try{
      const sess = buildSession(rows, f.name);
      newSessions.push(sess);
      perFile.push(sess);
    }catch(e){
      failCount++;
      const diag = diagnoseAMP(rows);
      const extra = diag ? `\n\nDetails:\n${diag}` : "";
      alert(`Parse failed for ${f.name}:\n${e.message || e}${extra}`);
    }
  }

  // Build “Detected fields” summary (per imported file)
  try{
    const okN = perFile.length;
    const totalN = files.length;
    const title = `Imported ${okN}/${totalN} file(s)` + (failCount?` (${failCount} failed)`:"");
    const items = perFile.map(s=>{
      const curves = s.hasCurves ? `yes (${(s.rounds[0]?.curve?.y?.length||0)} pts)` : "no";
      const curveMetrics = ["earlySpike","roughness","endFlat","endDrop","midSlope"].filter(k=>s.stats && s.stats[k]).map(k=>s.stats[k].label||k);
      const scalars = ["Peak Force","Work Done","Starting Pos","Terminal Force"];
      return `
        <div style="padding:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; margin-top:10px; background:rgba(0,0,0,.14)">
          <div style="font-weight:900">${escapeHtml(s.name||"")}</div>
          <div class="small muted" style="margin-top:4px">
            Rounds: <span class="mono">${s.rounds.length}</span> · 
          </div>
          <div class="small" style="margin-top:6px">
            Metrics: ✅ ${scalars.map(x=>'<span class="chip">'+escapeHtml(x)+'</span>').join(' ')}
          </div>
          <div class="small" style="margin-top:6px">
            Diagnostics: </div>
        </div>`;
    }).join("");
    const next = okN ? `
      <div class="hint" style="margin-top:10px">
        Next: choose a session, review highlighted rows, then use <span class="chip">Export shown</span> when you're ready.
      </div>` : "";
    setImportReport({ title, html: items + next });
  }catch(e){}
  updateWizardUI();

  if(!newSessions.length) return;
  newSessions.forEach(s=>recomputeSessionPostFlags(s));
  state.sessions = state.sessions.concat(newSessions);
  state.activeIndex = state.sessions.length - newSessions.length; // jump to first newly added
  renderSessionOptions();
  render();

  try{
    // onboarding nudge: move attention to the next “thing to do”
    if(els.sessionSel) els.sessionSel.focus();
    const roundsHdr = document.querySelector('section.card h2');
    // Prefer scroll to Rounds section if it exists
    const roundsSection = Array.from(document.querySelectorAll('section.card h2')).find(x=>String(x.textContent||'').trim()==='Rounds');
    if(roundsSection) roundsSection.scrollIntoView({block:'start'});
  }catch(e){}

}

/* ========== wiring ========== */
els.fileIn.addEventListener('change', (e)=>loadFiles(e.target.files));

els.drop.addEventListener('dragover', (e)=>{ e.preventDefault(); els.drop.style.filter="brightness(1.1)"; });
els.drop.addEventListener('dragleave', ()=>{ els.drop.style.filter=""; });
els.drop.addEventListener('drop', (e)=>{
  e.preventDefault(); els.drop.style.filter="";
  loadFiles(e.dataTransfer.files);
});

els.sessionSel.addEventListener('change', ()=>{
  state.activeIndex = Number(els.sessionSel.value)||0;
  // recompute scores because threshold might change (flyer already done)
  render();
});
els.th.addEventListener('input', ()=>{
  state.threshold = Number(els.th.value);
  els.thVal.textContent = state.threshold.toFixed(2);
  saveSettings();
  render();
});

els.es.addEventListener('input', ()=>{
  state.esLimit = Number(els.es.value);
  els.esVal.textContent = String(state.esLimit);
  // recompute ES exclusions/tags for all sessions
  state.sessions = state.sessions.map(s=>recomputeSessionPostFlags(s));
  saveSettings();
  render();
});
els.esAuto.addEventListener('change', ()=>{
  state.esAutoExclude = els.esAuto.checked;
  state.sessions = state.sessions.map(s=>recomputeSessionPostFlags(s));
  saveSettings();
  render();
});
els.hideEx.addEventListener('change', ()=>{
  state.hideExcluded = els.hideEx.checked;
  saveSettings();
  render();
});
els.tabRounds.addEventListener('click', ()=>{
  state.view='rounds';
  els.tabRounds.classList.add('active'); els.tabSessions.classList.remove('active'); if(els.tabCorr) els.tabCorr.classList.remove('active');
  els.tableWrap.style.display = (getActiveSession() ? 'block':'none');
  els.sessionsWrap.style.display = 'none';
});
els.tabSessions.addEventListener('click', ()=>{
  state.view='sessions';
  els.tabSessions.classList.add('active'); els.tabRounds.classList.remove('active');
  els.sessionsWrap.style.display = (state.sessions.length ? 'block':'none');
  els.tableWrap.style.display = 'none';
  renderSessionsView();
});
els.btnExportSessions.addEventListener('click', exportSessionsCSV);
if(els.btnCompareClear) els.btnCompareClear.addEventListener('click', ()=>{
renderSessionsView(); });

// Correlation tab removed for now (ShotLedger integration pending).
// (Code retained but not bound unless the Correlation UI exists.)
if (els.tabCorr && els.corrWrap) {
  els.tabCorr.addEventListener('click', ()=>{
    state.view='corr';
    els.tabCorr.classList.add('active'); els.tabRounds.classList.remove('active'); els.tabSessions.classList.remove('active');
    els.corrWrap.style.display = 'block';
    els.tableWrap.style.display = 'none';
    els.sessionsWrap.style.display = 'none';
    renderCorrelationView();
  });
  if(els.corrFile) els.corrFile.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) handleCorrFile(f);
    e.target.value = '';
  });
  if(els.btnCorrClear) els.btnCorrClear.addEventListener('click', ()=>{
    state.shotLedger = null;
    if(els.corrTbody) els.corrTbody.innerHTML = '';
    renderCorrelationView();
  });
}

function inferColumn(objKeys, needles){
  const keys = objKeys.map(k=>({k, lk:k.toLowerCase().replace(/\s+/g,'')}));
  for(const n of needles){
    const nn = n.toLowerCase().replace(/\s+/g,'');
    const found = keys.find(x=>x.lk===nn) || keys.find(x=>x.lk.includes(nn));
    if(found) return found.k;
  }
  return null;
}
function parseSimpleCSV(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  if(lines.length<2) return [];
  const delim = (lines[0].includes('\t') && !lines[0].includes(',')) ? '\t' : ',';
  const headers = lines[0].split(delim).map(h=>h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split(delim);
    const o={};
    headers.forEach((h,idx)=>{ o[h]= (parts[idx]??'').trim(); });
    rows.push(o);
  }
  return rows;
}
function readAsText(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(String(fr.result||''));
    fr.onerror = ()=>rej(new Error('read failed'));
    fr.readAsText(file);
  });
}
function pearson(xs, ys){
  const n = Math.min(xs.length, ys.length);
  if(n<3) return NaN;
  let sx=0, sy=0, sxx=0, syy=0, sxy=0;
  for(let i=0;i<n;i++){
    const x=xs[i], y=ys[i];
    sx+=x; sy+=y; sxx+=x*x; syy+=y*y; sxy+=x*y;
  }
  const cov = (sxy/n) - (sx/n)*(sy/n);
  const vx = (sxx/n) - (sx/n)*(sx/n);
  const vy = (syy/n) - (sy/n)*(sy/n);
  const den = Math.sqrt(vx*vy);
  return den>0 ? (cov/den) : NaN;
}
function buildCorrelationPoints(){
  const sess = getActiveSession();
  if(!sess || !sess.rounds || !sess.rounds.length) { state.corr.last = {traceKey:null, vertKey:null, matched:0, total:0}; return []; }
  if(!state.shotLedger || !state.shotLedger.rows || !state.shotLedger.rows.length) { state.corr.last = {traceKey:null, vertKey:null, matched:0, total:sess.rounds.length}; return []; }

  const rows = state.shotLedger.rows;
  const keys = Object.keys(rows[0]||{});

  // detect vertical column (ShotMarker exports often use "Vert (MOA)")
  const vertKey = inferColumn(keys, ['vert(moa)','vert','vertical(moa)','vertical','verticalmoa','verticalin','vmoa','vin','v']);

  // choose join key
  let joinMode = (els.corrJoin && els.corrJoin.value) ? els.corrJoin.value : 'auto';
  let traceKey = null;

  if(joinMode === 'amp'){
    traceKey = inferColumn(keys, ['amp#','amp #','amp no','amp number','amp']);
  } else if(joinMode === 'shot'){
    traceKey = inferColumn(keys, ['shot#','shot #','shotno','shot no','shot']);
  } else if(joinMode === 'instring'){
    traceKey = inferColumn(keys, ['#instring','# in string','instring','stringindex','indexinstring']);
  } else {
    // auto preference order: AMP # (best), Shot #, # in String, then generic trace-like fields
    traceKey =
      inferColumn(keys, ['amp#','amp #','amp no','amp number']) ||
      inferColumn(keys, ['shot#','shot #','shotno','shot no']) ||
      inferColumn(keys, ['#instring','# in string','instring','stringindex']) ||
      inferColumn(keys, ['trace','traceno','trace#','round','round#','index']);
  }

  state.corr.last = {traceKey, vertKey, matched:0, total:sess.rounds.length};

  if(!traceKey || !vertKey) return [];

  // map shotledger by join number
  const map = new Map();
  rows.forEach(r=>{
    const t = Number(String(r[traceKey]??'').replace(/[^0-9.\-]/g,''));
    const v = Number(String(r[vertKey]??'').replace(/[^0-9.\-]/g,''));
    if(Number.isFinite(t) && Number.isFinite(v)) map.set(t, v);
  });

  const pts=[];
  sess.rounds.forEach(r=>{
    const t = Number(r.traceIndex||r.trace||r.traceNo||r.traceNum);
    if(!Number.isFinite(t)) return;
    if(!Number.isFinite(r.peakForce)) return;
    if(!map.has(t)) return;
    pts.push({trace:t, x:r.peakForce, y:map.get(t), flyer:!!r.flyer, excluded:!!r.excluded, r});
  });

  state.corr.last.matched = pts.length;
  return pts;
}
function renderCorrelationView(){
  if(!els.corrWrap) return;
  const sess = getActiveSession();
  const pts = buildCorrelationPoints();
  state.corr.points = pts;

  // status chips
  if(!state.shotLedger){
    els.corrStatus.textContent = 'No ShotLedger file loaded';
    els.corrStatus.title = 'Import a ShotLedger/ShotMarker export (CSV/TSV) that contains a join column (AMP # or Shot #) and a vertical column (e.g., Vert (MOA)).';
  } else {
    const last = state.corr.last || {};
    const joinLabel = last.traceKey ? `join: ${last.traceKey}` : 'join: —';
    const vertLabel = last.vertKey ? `vert: ${last.vertKey}` : 'vert: —';
    const matchLabel = (Number.isFinite(last.matched) && Number.isFinite(last.total)) ? `matched ${last.matched}/${last.total}` : '';
    els.corrStatus.textContent = `ShotLedger loaded • ${matchLabel}`;
    els.corrStatus.title = `${state.shotLedger.name||''}
${joinLabel} • ${vertLabel}`;
  }

  // table
  if(els.corrTbody){
    els.corrTbody.innerHTML = pts.map(p=>`
      <tr>
        <td class="mono">Trace ${p.trace}</td>
        <td class="mono">${fmt(p.x,3)}</td>
        <td class="mono">${fmt(p.y,3)}</td>
        <td><span class="pill ${p.flyer?'bad':'ok'}">${p.flyer?'true':'false'}</span></td>
        <td><span class="pill ${p.excluded?'warn':'ok'}">${p.excluded?'true':'false'}</span></td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="small">No matched points yet. Import a CSV with Trace and Vertical columns.</td></tr>`;
  }

  // chart
  const c = els.corrChart;
  if(!c) return;
  // ensure canvas matches displayed size (important when switching tabs)
  const rect = c.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const wantW = Math.max(320, Math.floor(rect.width * dpr));
  const wantH = Math.max(240, Math.floor(rect.height * dpr));
  if(c.width !== wantW || c.height !== wantH){ c.width = wantW; c.height = wantH; }
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  if(!sess){
    ctx.fillStyle='rgba(255,255,255,.55)'; ctx.font='14px ui-sans-serif';
    ctx.fillText('Load a session to view correlation.', 12, 22);
    return;
  }
  if(!pts.length){
    ctx.fillStyle='rgba(255,255,255,.55)'; ctx.font='14px ui-sans-serif';
    ctx.fillText('Import a ShotLedger CSV with Trace + Vertical to plot correlation.', 12, 22);
    return;
  }

  const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
  const r = pearson(xs, ys);
  els.corrStats.textContent = Number.isFinite(r) ? ('r: '+fmt(r,3)) : 'r: —';
  els.corrStats.title = Number.isFinite(r) ? 'Pearson correlation (Peak Force vs Vertical)' : '—';

  const xPad=34, yPad=18, plotW=W-xPad-18, plotH=H-yPad-26;
  const minX=Math.min(...xs), maxX=Math.max(...xs);
  const minY=Math.min(...ys), maxY=Math.max(...ys);
  const padX=(maxX-minX)*0.08 || 1;
  const padY=(maxY-minY)*0.10 || 1;
  const x0=minX-padX, x1=maxX+padX;
  const y0=minY-padY, y1=maxY+padY;
  const X = (v)=> xPad + ((v-x0)/(x1-x0))*plotW;
  const Y = (v)=> yPad + (1-((v-y0)/(y1-y0)))*plotH;

  // axes
  ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(xPad, yPad); ctx.lineTo(xPad, yPad+plotH); ctx.lineTo(xPad+plotW, yPad+plotH); ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,.55)'; ctx.font='12px ui-sans-serif';
  ctx.fillText('Peak Force (lb)', xPad+6, yPad+plotH+18);
  ctx.save(); ctx.translate(12, yPad+plotH/2); ctx.rotate(-Math.PI/2); ctx.fillText('Vertical (units)', 0, 0); ctx.restore();

  // regression line (simple least squares)
  let sx=0, sy=0, sxx=0, sxy=0, n=pts.length;
  pts.forEach(p=>{ sx+=p.x; sy+=p.y; sxx+=p.x*p.x; sxy+=p.x*p.y; });
  const denom = (n*sxx - sx*sx);
  if(Math.abs(denom)>1e-9){
    const m = (n*sxy - sx*sy)/denom;
    const b = (sy - m*sx)/n;
    const yA = m*x0 + b, yB = m*x1 + b;
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(X(x0), Y(yA)); ctx.lineTo(X(x1), Y(yB)); ctx.stroke(); ctx.setLineDash([]);
  }

  // points
  pts.forEach(p=>{
    const xx=X(p.x), yy=Y(p.y);
    let fill='rgba(124,220,255,.90)', rad=4, stroke=null, lw=2;
    if(p.excluded){ fill='rgba(200,200,210,.55)'; rad=3.5; }
    if(p.flyer){ stroke='rgba(255,85,85,.95)'; lw=2.5; }
    ctx.beginPath(); ctx.fillStyle=fill; ctx.arc(xx,yy,rad,0,Math.PI*2); ctx.fill();
    if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=lw; ctx.stroke(); }
  });
}

async function handleCorrFile(file){
  try{
    const txt = await readAsText(file);
    const rows = parseSimpleCSV(txt);
    state.shotLedger = { name: file.name, rows };
    renderCorrelationView();
  } catch(e){
    alert('Could not read correlation file.');
  }
}

// Trace chart controls
initTraceChartHover();
initInfoTips();
updateWizardUI();

if(els.tcOverlayWork) els.tcOverlayWork.addEventListener('change', ()=>{ state.traceChart.overlayWork = els.tcOverlayWork.checked; renderTraceChart(); });
if(els.tcUseFiltered) els.tcUseFiltered.addEventListener('change', ()=>{ state.traceChart.useFiltered = els.tcUseFiltered.checked; renderTraceChart(); });
if(els.tcShowExcluded) els.tcShowExcluded.addEventListener('change', ()=>{ state.traceChart.showExcluded = els.tcShowExcluded.checked; renderTraceChart(); });

els.onlyAnom.addEventListener('change', ()=>{ state.onlyAnom = els.onlyAnom.checked; syncQuickChips(); saveSettings(); render(); });
els.onlyActionable.addEventListener('change', ()=>{ state.onlyActionable = els.onlyActionable.checked; syncQuickChips(); saveSettings(); render(); });

// preset + quick chips
if(els.presetSel){
  els.presetSel.addEventListener('change', ()=>{
    applyPreset(els.presetSel.value);
  });
}

function toggleFlag(flag){
  state[flag] = !state[flag];
  // sync legacy checkboxes (for accessibility / keyboard users)
  if(flag==='onlyActionable' && els.onlyActionable) els.onlyActionable.checked = !!state.onlyActionable;
  if(flag==='onlyAnom' && els.onlyAnom) els.onlyAnom.checked = !!state.onlyAnom;
  if(flag==='onlyFlyers'){ /* no legacy checkbox */ }
  if(flag==='hideExcluded' && els.hideEx) els.hideEx.checked = !!state.hideExcluded;
  // changing chips means we’re no longer strictly on a preset
  if(els.presetSel && state.preset && state.preset!=='default'){
    // keep the selected preset label, but user has customized; do not auto-switch.
  }
  syncQuickChips();
  saveSettings();
  render();
}

if(els.chipActionable) els.chipActionable.addEventListener('click', ()=>toggleFlag('onlyActionable'));
if(els.chipAnom)       els.chipAnom.addEventListener('click', ()=>toggleFlag('onlyAnom'));
if(els.chipFlyers)     els.chipFlyers.addEventListener('click', ()=>toggleFlag('onlyFlyers'));
if(els.chipHideEx)     els.chipHideEx.addEventListener('click', ()=>toggleFlag('hideExcluded'));

if(els.advDetails){
  els.advDetails.addEventListener('toggle', ()=>{
    state.advOpen = !!els.advDetails.open;
    saveSettings();
  });
}

// Columns modal
if(els.colChipBtn) els.colChipBtn.addEventListener('click', ()=>openColModal());
if(els.colCloseBtn) els.colCloseBtn.addEventListener('click', ()=>closeColModal());
if(els.colModal){
  els.colModal.addEventListener('click', (e)=>{
    if(e.target === els.colModal) closeColModal();
  });
  els.colModal.querySelectorAll('input[type="checkbox"][data-col]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const k = cb.getAttribute('data-col');
      let vis = Array.isArray(state.visibleCols) ? state.visibleCols.slice() : [];
      if(cb.checked){
        if(!vis.includes(k)) vis.push(k);
      }else{
        vis = vis.filter(x=>x!==k);
      }
      // keep ordering stable like COL_ALL
      state.visibleCols = COL_ALL.filter(x=>vis.includes(x));
      applyColumnVisibility();
      saveSettings();
    });
  });
}
if(els.colShowEssentials) els.colShowEssentials.addEventListener('click', ()=>{
  state.visibleCols = COL_ESSENTIALS.slice();
  applyColumnVisibility(); syncColumnModalChecks(); saveSettings();
});
if(els.colShowAll) els.colShowAll.addEventListener('click', ()=>{
  state.visibleCols = COL_ALL.slice();
  applyColumnVisibility(); syncColumnModalChecks(); saveSettings();
});
els.q.addEventListener('input', ()=>{ state.query = els.q.value.trim(); saveSettings(); render(); });
els.sortSel.addEventListener('change', ()=>{
  const v = els.sortSel.value;
  if(v === 'custom'){
    // Only meaningful if a header sort is active
    if(!state.sortField){
      // revert to previous non-custom choice
      els.sortSel.value = state.sort && state.sort !== 'custom' ? state.sort : 'score_desc';
    } else {
      state.sort = 'custom';
    }
    saveSettings();
    render();
    return;
  }
  state.sort = v;
  state.sortField = null;
  state.sortDir = null;
  document.querySelectorAll('th').forEach(x=>x.classList.remove('sortedAsc','sortedDesc'));
  saveSettings();
  render();
});

els.baseSel.addEventListener('change', ()=>{
  state.baselineMode = els.baseSel.value;
  saveSettings();
  render();
});
els.btnSaveBase.addEventListener('click', ()=>{
  const sess = getActiveSession();
  if(!sess) return;
  state.baseline = sessionToBaseline(sess);
  saveBaseline(state.baseline);
  state.baselineMode = "custom";
  els.baseSel.value = "custom";
  render();
});
els.btnClrBase.addEventListener('click', ()=>{
  state.baseline = null;
  clearBaseline();
  if(state.baselineMode==="custom"){
    state.baselineMode = "none";
    els.baseSel.value = "none";
  }
  render();
});


// Offline & Portable modal
if(els.sysCloseBtn) els.sysCloseBtn.addEventListener('click', closeSysModal);
if(els.sysModal) els.sysModal.addEventListener('click', (e)=>{ if(e.target===els.sysModal) closeSysModal(); });
if(els.btnRunSelfTest) els.btnRunSelfTest.addEventListener('click', ()=>{ try{ renderSelfTestResults(runOfflineSelfTest()); }catch(e){ if(els.sysResults) els.sysResults.textContent = String(e||'Error'); } });
if(els.chkLockdown) els.chkLockdown.addEventListener('change', ()=>{ setLockdown(els.chkLockdown.checked); try{ renderSelfTestResults(runOfflineSelfTest()); }catch(e){} });

if(els.btnExportBundle) els.btnExportBundle.addEventListener('click', ()=>{ exportPortableBundle(); });
if(els.btnImportBundle) els.btnImportBundle.addEventListener('click', ()=>{ if(els.portableIn) els.portableIn.click(); });
if(els.portableIn) els.portableIn.addEventListener('change', async ()=>{
  const f = els.portableIn.files && els.portableIn.files[0];
  if(!f) return;
  const text = await f.text();
  const mode = (els.bundleMode && els.bundleMode.value) ? els.bundleMode.value : 'replace';
  const importSettings = els.bundleImportSettings ? !!els.bundleImportSettings.checked : true;
  importPortableBundleText(text, mode, importSettings);
  els.portableIn.value = '';
});

els.btnExport.addEventListener('click', exportShown);
els.btnCopy && els.btnCopy.addEventListener('click', copyShown);
els.btnClearSort && els.btnClearSort.addEventListener('click', clearHeaderSort);
els.btnReset && els.btnReset.addEventListener('click', ()=>{
  resetDefaults();
  // if ES auto-exclude changed, recompute flags
  state.sessions = state.sessions.map(s=>recomputeSessionPostFlags(s));
  render();
});

els.btnExportJSON && els.btnExportJSON.addEventListener('click', exportJSON);

els.btnImportJSON && els.btnImportJSON.addEventListener('click', ()=>{
  if(els.jsonIn) els.jsonIn.click();
});
/* ===== header “more” menu wiring ===== */
(function(){
  const btn = els.btnMore;
  const menu = els.moreMenu;
  if(!btn || !menu) return;

  function close(){
    menu.style.display = 'none';
    btn.setAttribute('aria-expanded','false');
  }
  function open(){
    menu.style.display = 'block';
    btn.setAttribute('aria-expanded','true');
  }
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const openNow = (menu.style.display !== 'none' && menu.style.display !== '');
    if(openNow) close(); else open();
  });
  document.addEventListener('click', ()=>close());
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  // menu items map to existing (hidden) buttons / actions
  if(els.miExportJSON) els.miExportJSON.addEventListener('click', ()=>{ close(); exportJSON(); markExported(); });
  if(els.miImportJSON) els.miImportJSON.addEventListener('click', ()=>{ close(); if(els.jsonIn) els.jsonIn.click(); });
  if(els.miCopy) els.miCopy.addEventListener('click', ()=>{ close(); copyShown(); });
  if(els.miClearSort) els.miClearSort.addEventListener('click', ()=>{ close(); clearHeaderSort(); });
  if(els.miReset) els.miReset.addEventListener('click', ()=>{ close(); resetDefaults(); state.sessions = state.sessions.map(s=>recomputeSessionPostFlags(s)); render(); });
  if(els.miClear) els.miClear.addEventListener('click', ()=>{ close(); els.btnClear && els.btnClear.click(); });
})();

els.jsonIn && els.jsonIn.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    const text = await f.text();
    importJSONText(text);
  }catch(err){
    alert("Couldn't read that file.");
  }finally{
    // allow re-importing the same filename
    e.target.value = "";
  }
});

els.btnClear.addEventListener('click', ()=>{
  state.sessions = [];
state._wizardImportedOnce = false;
  state._wizardExported = false;
  state.lastImportReport = null;
  updateWizardUI();
  renderDetectSummary();
  state.activeIndex = 0;
  state.selectedTraceIndex = null;
  state.lastImportReport = null;
  els.sessionSel.innerHTML="";
  renderDetectSummary();
  render();
});

// detected summary dismiss
if(els.btnClearDetect){
  els.btnClearDetect.addEventListener('click', ()=>{
    state.lastImportReport = null;
    renderDetectSummary();
  });
}

function selectShownDelta(delta){
  const sess = getActiveSession();
  if(!sess) return;
  const rows = state.shownRows || [];
  if(!rows.length) return;
  const ti = state.selectedTraceIndex;
  let idx = rows.findIndex(r=>r.traceIndex===ti);
  if(idx<0) idx = 0;
  idx = (idx + delta + rows.length) % rows.length;
  state.selectedTraceIndex = rows[idx].traceIndex;
  render();
}

if(els.btnInsPrev) els.btnInsPrev.addEventListener('click', ()=>selectShownDelta(-1));
if(els.btnInsNext) els.btnInsNext.addEventListener('click', ()=>selectShownDelta(+1));
if(els.btnInsClear) els.btnInsClear.addEventListener('click', ()=>{
  state.selectedTraceIndex = null;
  render();
});

if(els.insUserExcluded){
  els.insUserExcluded.addEventListener('change', ()=>{
    const sess = getActiveSession();
    const r = getSelectedRound(sess);
    if(!sess || !r) return;
    r.userExcluded = !!els.insUserExcluded.checked;
    recomputeSessionPostFlags(sess);
    render();
  });
}

if(els.btnInsTagSave){
  els.btnInsTagSave.addEventListener('click', ()=>{
    const sess = getActiveSession();
    const r = getSelectedRound(sess);
    if(!sess || !r) return;
    r.userTag = String(els.insTag.value||"").trim();
    recomputeSessionPostFlags(sess);
    render();
  });
}
if(els.btnInsTagClear){
  els.btnInsTagClear.addEventListener('click', ()=>{
    const sess = getActiveSession();
    const r = getSelectedRound(sess);
    if(!sess || !r) return;
    r.userTag = "";
    els.insTag.value = "";
    recomputeSessionPostFlags(sess);
    render();
  });
}


/* ========== init baseline + render ========== */
state.baseline = loadBaseline();
// load persisted view settings
applySettingsToStateAndUI(loadSettings());
setupHeaderSort();
renderDetectSummary();
render();

// Version stamp (single source of truth)
applyBuildTag();
</script>
<div id="floatTip" style="position:fixed; display:none; z-index:50; max-width:360px; background:rgba(8,12,20,.92); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 10px; box-shadow:0 10px 30px rgba(0,0,0,.35); font-size:12px; color:rgba(255,255,255,.92); pointer-events:none"></div>


</body>
</html>
